# Структура проекта

## Обзор
Проект VPN Memory Bank организован в несколько ключевых компонентов, которые работают вместе для обеспечения полного решения VPN-сервиса с многоузловой архитектурой, обработкой платежей и управлением пользователями.

## Основные компоненты

### 1. Бэкенд-сервис (`/vpn-service/backend/`)
Ядро приложения, обрабатывающее API-запросы, операции с базой данных и бизнес-логику.

- **Основное приложение** (`/app/`): Точка входа FastAPI и основные маршруты
- **Модели** (`/models/`): Модели базы данных SQLAlchemy
- **Сервисы** (`/services/`): Бизнес-логика и внешние интеграции
- **Маршруты** (`/routes/`): API-эндпоинты и контроллеры
- **Интерфейс администратора** (`/app/admin/`): Веб-панель администрирования
- **Шаблоны** (`/app/templates/`): HTML-шаблоны для интерфейса администратора
- **Миграции** (`/migrations/`): Миграции схемы базы данных
- **Скрипты** (`/scripts/`): Служебные скрипты для задач обслуживания

### 2. Telegram-бот (`/vpn-service/bot/`)
Пользовательский интерфейс для управления VPN через Telegram.

- **Обработчики** (`/handlers/`): Обработчики сообщений и команд
- **Клавиатуры** (`/keyboards/`): Пользовательские компоненты интерфейса Telegram
- **Сервисы** (`/services/`): Бизнес-логика, специфичная для бота
- **Модели** (`/models/`): Модели данных для операций бота
- **Промежуточное ПО** (`/middleware/`): Промежуточное ПО для обработки запросов
- **Шаблоны** (`/templates/`): Шаблоны сообщений

### 3. Memory Bank (`/memory-bank/`)
Документация проекта и артефакты разработки.

- **Архив** (`/archive/`): Историческая документация проекта
- **Креатив** (`/creative/`): Документы по дизайну и архитектурные решения
- **Рефлексия** (`/reflection/`): Ретроспективы проекта и извлеченные уроки

### 4. Инфраструктура
Конфигурационные файлы для развертывания и настройки окружения.

- **Конфигурация Docker** (`/vpn-service/docker-compose.yml`): Оркестрация контейнеров
- **Конфигурация окружения** (`/vpn-service/.env`): Переменные окружения
- **Скрипты развертывания** (`/deploy.sh`): Автоматизация развертывания в продакшн

## Ключевые файлы

### Бэкенд
- `main.py`: Точка входа приложения
- `alembic.ini`: Конфигурация миграции базы данных
- `models/*.py`: Определения схемы базы данных
- `services/*.py`: Компоненты основной бизнес-логики
- `app/admin/routes.py`: Маршруты панели администратора
- `app/templates/admin/*.html`: Шаблоны интерфейса администратора

### Бот
- `main.py`: Точка входа бота
- `handlers/*.py`: Обработчики команд
- `keyboards/main_menu.py`: Компоненты пользовательского интерфейса
- `services/vpn_manager_x3ui.py`: Интеграция управления VPN

### Конфигурация
- `vpn-service/.env`: Консолидированные переменные окружения
- `docker-compose.yml`: Настройка среды разработки
- `docker-compose.prod.yml`: Настройка продакшн-среды

## Архитектурные паттерны

### 1. Паттерн сервисного слоя
Бизнес-логика инкапсулирована в сервисных классах, которые обрабатывают конкретные домены:
- `payment_service.py`
- `subscription_service.py`
- `vpn_key_lifecycle_service.py`
- `node_automation.py`

### 2. Паттерн фабрики
Используется для обработки платежей для поддержки нескольких провайдеров:
- `payment_processor_factory.py`
- `payment_processor_base.py`
- Конкретные реализации: `robokassa_processor.py`, `freekassa_service.py`

### 3. Паттерн репозитория
Доступ к базе данных абстрагирован через репозитории для конкретных моделей:
- Модели SQLAlchemy в `/models/`
- Сервисные классы обрабатывают операции с базой данных

### 4. Паттерн одиночки (Singleton)
Используется для настроек приложения и общих ресурсов:
- `app_settings.py` (настройки, хранящиеся в базе данных)
- `plans_cache.py` (кэш планов подписки)

### 5. Внедрение зависимостей
Внедрение зависимостей FastAPI для сессий базы данных и сервисов:
- Сессии базы данных внедряются в обработчики маршрутов
- Сервисы составляются с их зависимостями