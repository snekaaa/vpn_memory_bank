# –ü–õ–ê–ù–ò–†–û–í–ê–ù–ò–ï: –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–µ–π –¥–ª—è –ø–æ–¥–ø–∏—Å–æ–∫

## üìã –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –£–†–û–í–ù–Ø –°–õ–û–ñ–ù–û–°–¢–ò
**–£—Ä–æ–≤–µ–Ω—å**: Level 3 (Intermediate Feature)
**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ**: 
- –¢—Ä–µ–±—É–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –≤–Ω–µ—à–Ω–∏–º API (Robokassa)
- –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö (–ë–î, –±–æ—Ç, –∞–¥–º–∏–Ω–∫–∞, —Å–µ—Ä–≤–∏—Å—ã)
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ –∑–∞–¥–∞—á –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Å–ø–∏—Å–∞–Ω–∏–π

## üéØ –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ò –ê–ù–ê–õ–ò–ó

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:
1. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–µ–π –≤ Robokassa** –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç–µ
2. **–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ —Å–ø–∏—Å–∞–Ω–∏—è** –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é –ø–æ–¥–ø–∏—Å–∫–∏
3. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ** –ø–æ–¥–ø–∏—Å–∫–∏ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º —Å–ø–∏—Å–∞–Ω–∏–∏
4. **–ò–∑–º–µ–Ω–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –±–æ—Ç–∞** —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∞—Ö
5. **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∞–º–∏ –≤ –∞–¥–º–∏–Ω–∫–µ**
6. **–û—Ç–º–µ–Ω–∞ –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–µ–π** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Robokassa API –¥–ª—è –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–µ–π
- Cron-–ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫
- –ù–æ–≤—ã–µ –ø–æ–ª—è –≤ –ë–î –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–µ–π
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –±–æ—Ç–∞ –∏ –∞–¥–º–∏–Ω–∫–∏

## üèóÔ∏è –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–´–ï –ö–û–ú–ü–û–ù–ï–ù–¢–´

### –ú–æ–¥–µ–ª–∏ –ë–î:
- **Payment**: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª–µ–π –¥–ª—è –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–µ–π
- **Subscription**: –ø–æ–ª—è –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∞–º–∏
- **AutoPayment**: –Ω–æ–≤–∞—è –º–æ–¥–µ–ª—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–µ–π

### –°–µ—Ä–≤–∏—Å—ã:
- **AutoPaymentService**: —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∞–º–∏
- **RobokassaAutoPaymentService**: –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Robokassa API
- **SubscriptionRenewalService**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–æ–∫
- **PaymentSchedulerService**: –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏—Ö —Å–ø–∏—Å–∞–Ω–∏–π

### –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã:
- **Bot**: –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–¥–ø–∏—Å–æ–∫ —Å –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∞–º–∏
- **Admin**: —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

## ‚úÖ –°–¢–ê–¢–£–° –¢–í–û–†–ß–ï–°–ö–û–ô –§–ê–ó–´ - –ó–ê–í–ï–†–®–ï–ù–ê

### üé® –ü–†–û–†–ê–ë–û–¢–ê–ù–ù–´–ï –ö–û–ú–ü–û–ù–ï–ù–¢–´:

#### 1. UX –¥–ª—è –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–µ–π –≤ –±–æ—Ç–µ ‚úÖ 
**–†–µ—à–µ–Ω–∏–µ**: –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ —Ä–∞–∑–¥–µ–ª–µ "–ü–æ–¥–ø–∏—Å–∫–∞"
- –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –ø–æ–¥ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∞
- –ß–µ—Ç–∫–∏–µ call-to-action –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è
- –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –±–µ–∑ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞

#### 2. –ê–ª–≥–æ—Ä–∏—Ç–º –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫ ‚úÖ
**–†–µ—à–µ–Ω–∏–µ**: –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –ø–æ —Ç–∏–ø—É –æ—à–∏–±–∫–∏
- –ù–µ–¥–æ—Å—Ç–∞—Ç–æ–∫ —Å—Ä–µ–¥—Å—Ç–≤: 24—á ‚Üí 72—á ‚Üí 7 –¥–Ω–µ–π (3 –ø–æ–ø—ã—Ç–∫–∏)
- –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏: 1—á ‚Üí 6—á ‚Üí 24—á (3 –ø–æ–ø—ã—Ç–∫–∏)
- –ü—Ä–æ–±–ª–µ–º—ã —Å –∫–∞—Ä—Ç–æ–π: 24—á (1 –ø–æ–ø—ã—Ç–∫–∞)

#### 3. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ‚úÖ
**–†–µ—à–µ–Ω–∏–µ**: –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
- –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤—Å–µ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è
- –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø–æ –≤—ã–±–æ—Ä—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –°–æ–±–ª—é–¥–µ–Ω–∏–µ —Ç–∏—Ö–∏—Ö —á–∞—Å–æ–≤ –∏ preferences

### üìù –ì–û–¢–û–í–´–ï GUIDELINES:
- –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –æ—à–∏–±–æ–∫ –ø–ª–∞—Ç–µ–∂–µ–π
- –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
- –®–∞–±–ª–æ–Ω—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
- –ü—Ä–∏–Ω—Ü–∏–ø—ã UX –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞

**üìÑ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**: `memory-bank/creative/creative-autopay-system.md`

## üìä –°–¢–ê–¢–£–° –†–ï–ê–õ–ò–ó–ê–¶–ò–ò - ‚úÖ –í–°–ï –≠–¢–ê–ü–´ –ó–ê–í–ï–†–®–ï–ù–´

### ‚úÖ –≠—Ç–∞–ø 1: –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π –ë–î - –ó–ê–í–ï–†–®–ï–ù
- [x] –°–æ–∑–¥–∞–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è `009_add_auto_payments.sql`
- [x] –û–±–Ω–æ–≤–ª–µ–Ω–∞ –º–æ–¥–µ–ª—å Payment —Å –Ω–æ–≤—ã–º–∏ –ø–æ–ª—è–º–∏ –¥–ª—è –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–µ–π
- [x] –°–æ–∑–¥–∞–Ω–∞ –º–æ–¥–µ–ª—å AutoPayment
- [x] –°–æ–∑–¥–∞–Ω–∞ –º–æ–¥–µ–ª—å PaymentRetryAttempt
- [x] –°–æ–∑–¥–∞–Ω–∞ –º–æ–¥–µ–ª—å UserNotificationPreferences
- [x] –û–±–Ω–æ–≤–ª–µ–Ω–∞ –º–æ–¥–µ–ª—å Subscription —Å –ø–æ–ª—è–º–∏ –¥–ª—è –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–µ–π

### ‚úÖ –≠—Ç–∞–ø 2: Robokassa Auto Payment Service - –ó–ê–í–ï–†–®–ï–ù
- [x] –î–æ–±–∞–≤–ª–µ–Ω—ã –º–µ—Ç–æ–¥—ã recurring API –≤ RobokassaService
- [x] –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω create_recurring_payment_url
- [x] –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω create_recurring_subscription
- [x] –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω cancel_recurring_subscription
- [x] –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –º–µ—Ç–æ–¥—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- [x] –°–æ–∑–¥–∞–Ω AutoPaymentService –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∞–º–∏

### ‚úÖ –≠—Ç–∞–ø 3: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –ø–ª–∞—Ç–µ–∂–Ω—ã–π workflow - –ó–ê–í–ï–†–®–ï–ù
- [x] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ webhook –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–ª—è –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–µ–π
- [x] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞ —Å —Ñ–ª–∞–≥–æ–º recurring
- [x] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è AutoPaymentService –≤ payment flow
- [x] –î–æ–±–∞–≤–ª–µ–Ω —Ñ–ª–∞–≥ enable_autopay –≤ CreatePaymentRequest
- [x] –û–±–Ω–æ–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ process_robokassa_payment –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–µ–π
- [x] –ü–æ–¥–¥–µ—Ä–∂–∫–∞ recurring URL –≤ –æ–±–µ–∏—Ö —Å–∏—Å—Ç–µ–º–∞—Ö (—Å—Ç–∞—Ä–æ–π –∏ –Ω–æ–≤–æ–π)

### ‚úÖ –≠—Ç–∞–ø 4: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –±–æ—Ç–∞ - –ó–ê–í–ï–†–®–ï–ù
- [x] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ handlers/payments.py
- [x] –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä —Å –æ–ø—Ü–∏–µ–π –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∞
- [x] –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∞–º–∏

### ‚úÖ –≠—Ç–∞–ø 5: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∫–∏ - –ó–ê–í–ï–†–®–ï–ù  
- [x] –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–µ–π –≤ –ø—Ä–æ—Ñ–∏–ª–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- [x] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –ø–ª–∞—Ç–µ–∂–µ–π —Å –∫–æ–ª–æ–Ω–∫–æ–π —Ç–∏–ø–∞
- [x] –°—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–µ—Ç–∞–ª–µ–π –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∞
- [x] –î–µ–π—Å—Ç–≤–∏—è –∞–¥–º–∏–Ω–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (API endpoint)
- [x] –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–µ–π –≤ –º–∞—Ä—à—Ä—É—Ç–µ –ø—Ä–æ—Ñ–∏–ª—è

### ‚úÖ –≠—Ç–∞–ø 6: –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–µ–π - –ó–ê–í–ï–†–®–ï–ù
- [x] PaymentSchedulerService —Å –ø–æ–ª–Ω–æ–π –ª–æ–≥–∏–∫–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
- [x] Cron job —Å–∫—Ä–∏–ø—Ç (autopay_cron.py)
- [x] –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π —Å retry –ª–æ–≥–∏–∫–æ–π
- [x] –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ —Å—Ç–∞—Ç—É—Å–µ –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–µ–π

## üìù –î–ï–¢–ê–õ–¨–ù–´–ô –ü–õ–ê–ù –†–ï–ê–õ–ò–ó–ê–¶–ò–ò

### –≠—Ç–∞–ø 1: –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π –ë–î
**–¶–µ–ª—å**: –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–µ–π –Ω–∞ —É—Ä–æ–≤–Ω–µ –¥–∞–Ω–Ω—ã—Ö

#### 1.1 –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ Payment
```python
# –ù–æ–≤—ã–µ –ø–æ–ª—è –≤ Payment
robokassa_recurring_id = Column(String, nullable=True)  # ID —Ä–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞ –≤ Robokassa
is_recurring_enabled = Column(Boolean, default=False)
recurring_period_days = Column(Integer, nullable=True)
next_payment_date = Column(DateTime, nullable=True)
recurring_status = Column(Enum(RecurringStatus), default=RecurringStatus.INACTIVE)
is_recurring_setup = Column(Boolean, default=False)  # –§–ª–∞–≥ –ø–µ—Ä–≤–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞ –¥–ª—è setup
```

#### 1.2 –ù–æ–≤–∞—è –º–æ–¥–µ–ª—å AutoPayment
```python
# models/auto_payment.py
class AutoPayment(Base):
    id, user_id, subscription_id, payment_id
    robokassa_recurring_id, amount, currency
    period_days, next_payment_date
    status, created_at, updated_at
    attempts_count, last_attempt_date
```

#### 1.3 –ù–æ–≤–∞—è –º–æ–¥–µ–ª—å PaymentRetryAttempt
```python
# models/payment_retry_attempt.py
class PaymentRetryAttempt(Base):
    id = Column(Integer, primary_key=True)
    auto_payment_id = Column(Integer, ForeignKey('auto_payments.id'), nullable=False)
    attempt_number = Column(Integer, nullable=False)
    error_type = Column(String, nullable=False)  # 'insufficient_funds', 'technical_error', 'card_issue'
    error_message = Column(Text, nullable=True)  # –ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏ –æ—Ç Robokassa
    scheduled_at = Column(DateTime, nullable=False)
    attempted_at = Column(DateTime, nullable=True)
    result = Column(String, nullable=True)  # 'success', 'failed', 'pending'
    next_attempt_at = Column(DateTime, nullable=True)
    user_notified = Column(Boolean, default=False)
    robokassa_response = Column(Text, nullable=True)  # Raw –æ—Ç–≤–µ—Ç API –¥–ª—è –¥–µ–±–∞–≥–∞
    created_at = Column(DateTime, default=func.now())
```

#### 1.4 –ú–æ–¥–µ–ª—å UserNotificationPreferences
```python
# models/user_notification_preferences.py
class UserNotificationPreferences(Base):
    user_id, notification_type, enabled
    frequency, quiet_hours_start, quiet_hours_end
```

#### 1.5 Enum –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ recurring
```python
# models/payment.py
class RecurringStatus(str, enum.Enum):
    INACTIVE = "inactive"
    ACTIVE = "active" 
    PAUSED = "paused"
    CANCELLED = "cancelled"
    FAILED = "failed"
```

#### 1.6 –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î
- –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª `009_add_auto_payments.sql`
- –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã –∏ –ø–æ–ª—è

### –≠—Ç–∞–ø 2: Robokassa Auto Payment Service
**–¶–µ–ª—å**: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å API Robokassa –¥–ª—è –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–µ–π

#### 2.1 –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ RobokassaService - Recurring API
```python
# services/robokassa_service.py

# 1. –ü–µ—Ä–≤—ã–π –ø–ª–∞—Ç–µ–∂ —Å setup recurring
def create_recurring_payment_url(
    self, 
    amount: float, 
    order_id: str, 
    description: str,
    recurring: bool = True,  # –§–ª–∞–≥ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ recurring
    **kwargs
) -> Dict[str, Any]:
    """–°–æ–∑–¥–∞–Ω–∏–µ URL –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ recurring –ø–ª–∞—Ç–µ–∂–∞"""
    params = {
        'MerchantLogin': self.shop_id,
        'OutSum': str(amount),
        'InvId': order_id,
        'Description': description,
        'Recurring': 'true' if recurring else 'false',
        'IsTest': '1' if self.test_mode else '0'
    }
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–æ–¥–ø–∏—Å—å
    signature = self._generate_signature(params, self.password1)
    params['SignatureValue'] = signature
    
    query_string = urlencode(params)
    payment_url = f"{self.base_url}?{query_string}"
    
    return {'url': payment_url}

# 2. –°–æ–∑–¥–∞–Ω–∏–µ recurring –ø–æ–¥–ø–∏—Å–∫–∏ —á–µ—Ä–µ–∑ API
async def create_recurring_subscription(
    self,
    previous_invoice_id: str,  # ID –ø–µ—Ä–≤–æ–≥–æ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞
    amount: float,
    period_days: int,
    description: str
) -> Dict[str, Any]:
    """–°–æ–∑–¥–∞–Ω–∏–µ recurring –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞"""
    
    params = {
        'MerchantLogin': self.shop_id,
        'OutSum': str(amount),
        'PreviousInvoiceID': previous_invoice_id,
        'Description': description
    }
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–æ–¥–ø–∏—Å—å –¥–ª—è recurring API
    signature = self._generate_signature(params, self.password1)
    params['SignatureValue'] = signature
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ Robokassa Recurring API
    recurring_url = "https://auth.robokassa.ru/Merchant/Recurring"
    
    async with aiohttp.ClientSession() as session:
        async with session.post(recurring_url, data=params) as response:
            result = await response.text()
            
            if "OK" in result:
                recurring_id = result.replace("OK", "").strip()
                return {
                    'success': True,
                    'recurring_id': recurring_id,
                    'status': 'created'
                }
            else:
                return {
                    'success': False,
                    'error': result,
                    'status': 'failed'
                }

# 3. –û—Ç–º–µ–Ω–∞ recurring –ø–æ–¥–ø–∏—Å–∫–∏
async def cancel_recurring_subscription(
    self,
    recurring_id: str
) -> Dict[str, Any]:
    """–û—Ç–º–µ–Ω–∞ recurring –ø–æ–¥–ø–∏—Å–∫–∏"""
    
    params = {
        'MerchantLogin': self.shop_id,
        'ID': recurring_id
    }
    
    signature = self._generate_signature(params, self.password1)
    params['SignatureValue'] = signature
    
    cancel_url = "https://auth.robokassa.ru/Merchant/CancelRecurring"
    
    async with aiohttp.ClientSession() as session:
        async with session.post(cancel_url, data=params) as response:
            result = await response.text()
            return {
                'success': "OK" in result,
                'result': result
            }

# 4. –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ recurring
async def get_recurring_status(
    self,
    recurring_id: str
) -> Dict[str, Any]:
    """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ recurring –ø–æ–¥–ø–∏—Å–∫–∏"""
    
    params = {
        'MerchantLogin': self.shop_id,
        'ID': recurring_id
    }
    
    signature = self._generate_signature(params, self.password1)
    params['SignatureValue'] = signature
    
    status_url = "https://auth.robokassa.ru/Merchant/GetRecurringStatus"
    
    async with aiohttp.ClientSession() as session:
        async with session.post(status_url, data=params) as response:
            result = await response.text()
            # –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç Robokassa
            return self._parse_recurring_status(result)

# 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ recurring_id –ø–µ—Ä–µ–¥ —Å–ø–∏—Å–∞–Ω–∏–µ–º
async def validate_recurring_id(
    self,
    recurring_id: str
) -> Dict[str, Any]:
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ recurring_id –ø–µ—Ä–µ–¥ –ø–æ–ø—ã—Ç–∫–æ–π —Å–ø–∏—Å–∞–Ω–∏—è"""
    
    try:
        status_result = await self.get_recurring_status(recurring_id)
        
        if status_result.get('status') == 'active':
            return {
                'valid': True,
                'status': status_result.get('status'),
                'message': 'Recurring ID –∞–∫—Ç–∏–≤–µ–Ω'
            }
        else:
            return {
                'valid': False,
                'status': status_result.get('status'),
                'message': f'Recurring ID –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω: {status_result.get("status")}'
            }
    except Exception as e:
        return {
            'valid': False,
            'status': 'error',
            'message': f'–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ recurring_id: {str(e)}'
        }

# 6. –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –ø–æ–¥–ø–∏—Å—å –¥–ª—è Recurring API
def _generate_recurring_signature(
    self,
    params: Dict[str, Any],
    password: str
) -> str:
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏ –¥–ª—è Recurring API –∑–∞–ø—Ä–æ—Å–æ–≤"""
    
    # –î–ª—è Recurring API –ø–æ–¥–ø–∏—Å—å –º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –æ—Ç –æ–±—ã—á–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é Robokassa –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞
    sorted_params = sorted(params.items())
    signature_string = ':'.join([f"{key}={value}" for key, value in sorted_params])
    signature_string += f":{password}"
    
    return hashlib.md5(signature_string.encode('utf-8')).hexdigest()

# 7. –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
async def create_recurring_subscription_with_logging(
    self,
    auto_payment_id: int,
    previous_invoice_id: str,
    amount: float,
    description: str,
    attempt_number: int = 1
) -> Dict[str, Any]:
    """–°–æ–∑–¥–∞–Ω–∏–µ recurring –ø–æ–¥–ø–∏—Å–∫–∏ —Å –ø–æ–ª–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º"""
    
    params = {
        'MerchantLogin': self.shop_id,
        'OutSum': str(amount),
        'PreviousInvoiceID': previous_invoice_id,
        'Description': description
    }
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é –ø–æ–¥–ø–∏—Å—å –¥–ª—è Recurring API
    signature = self._generate_recurring_signature(params, self.password1)
    params['SignatureValue'] = signature
    
    recurring_url = "https://auth.robokassa.ru/Merchant/Recurring"
    
    # –õ–æ–≥–∏—Ä—É–µ–º –ø–æ–ø—ã—Ç–∫—É
    retry_attempt = PaymentRetryAttempt(
        auto_payment_id=auto_payment_id,
        attempt_number=attempt_number,
        scheduled_at=datetime.now(),
        attempted_at=datetime.now()
    )
    
    try:
        async with aiohttp.ClientSession() as session:
            async with session.post(recurring_url, data=params) as response:
                result = await response.text()
                
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º raw –æ—Ç–≤–µ—Ç –¥–ª—è –¥–µ–±–∞–≥–∞
                retry_attempt.robokassa_response = result
                
                if "OK" in result:
                    recurring_id = result.replace("OK", "").strip()
                    retry_attempt.result = 'success'
                    
                    return {
                        'success': True,
                        'recurring_id': recurring_id,
                        'status': 'created'
                    }
                else:
                    # –ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
                    error_type = self._classify_robokassa_error(result)
                    retry_attempt.error_type = error_type
                    retry_attempt.error_message = result
                    retry_attempt.result = 'failed'
                    
                    return {
                        'success': False,
                        'error': result,
                        'error_type': error_type,
                        'status': 'failed'
                    }
                    
    except Exception as e:
        retry_attempt.error_type = 'technical_error'
        retry_attempt.error_message = str(e)
        retry_attempt.result = 'failed'
        
        return {
            'success': False,
            'error': str(e),
            'error_type': 'technical_error',
            'status': 'failed'
        }
    finally:
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–≥ –ø–æ–ø—ã—Ç–∫–∏ –≤ –ë–î
        self.db.add(retry_attempt)
        await self.db.commit()

# 8. –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –æ—à–∏–±–æ–∫ Robokassa
def _classify_robokassa_error(self, error_message: str) -> str:
    """–ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –æ—à–∏–±–æ–∫ –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ—Ç–≤–µ—Ç–∞ Robokassa"""
    
    error_lower = error_message.lower()
    
    if any(keyword in error_lower for keyword in ['insufficient', '–Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ', 'funds', '—Å—Ä–µ–¥—Å—Ç–≤']):
        return 'insufficient_funds'
    elif any(keyword in error_lower for keyword in ['card', '–∫–∞—Ä—Ç–∞', 'blocked', '–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞', 'expired', '–∏—Å—Ç–µ–∫–ª–∞']):
        return 'card_issue'
    elif any(keyword in error_lower for keyword in ['cancelled', '–æ—Ç–º–µ–Ω–µ–Ω', 'user']):
        return 'user_cancelled'
    elif any(keyword in error_lower for keyword in ['technical', '—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è', 'error', '–æ—à–∏–±–∫–∞', 'timeout']):
        return 'technical_error'
    else:
        return 'unknown_error'
```

#### 2.2 –ù–æ–≤—ã–π AutoPaymentService
```python
# services/auto_payment_service.py
class AutoPaymentService:
    
    async def setup_auto_payment(
        self,
        user_id: int,
        payment_id: int,
        previous_invoice_id: str
    ) -> Dict[str, Any]:
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞"""
        
        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∞ –∏ –ø–æ–¥–ø–∏—Å–∫–∏
        payment = await self._get_payment(payment_id)
        subscription = await self._get_user_subscription(user_id)
        
        # –°–æ–∑–¥–∞–µ–º recurring –≤ Robokassa
        robokassa_service = RobokassaService(provider_config)
        recurring_result = await robokassa_service.create_recurring_subscription(
            previous_invoice_id=previous_invoice_id,
            amount=subscription.price,
            period_days=self._get_period_days(subscription.subscription_type),
            description=f"–ê–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ {subscription.plan_name}"
        )
        
        if recurring_result['success']:
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂ –≤ –ë–î
            auto_payment = AutoPayment(
                user_id=user_id,
                subscription_id=subscription.id,
                payment_id=payment_id,
                robokassa_recurring_id=recurring_result['recurring_id'],
                amount=subscription.price,
                currency='RUB',
                period_days=self._get_period_days(subscription.subscription_type),
                next_payment_date=self._calculate_next_payment_date(subscription),
                status='active'
            )
            
            self.db.add(auto_payment)
            await self.db.commit()
            
            return {
                'success': True,
                'auto_payment_id': auto_payment.id,
                'recurring_id': recurring_result['recurring_id']
            }
        
        return recurring_result
    
    async def cancel_auto_payment(
        self,
        user_id: int
    ) -> Dict[str, Any]:
        """–û—Ç–º–µ–Ω–∞ –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        
        # –ù–∞—Ö–æ–¥–∏–º –∞–∫—Ç–∏–≤–Ω—ã–π –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂
        auto_payment = await self._get_active_auto_payment(user_id)
        
        if auto_payment:
            # –û—Ç–º–µ–Ω—è–µ–º –≤ Robokassa
            robokassa_service = RobokassaService(provider_config)
            cancel_result = await robokassa_service.cancel_recurring_subscription(
                auto_payment.robokassa_recurring_id
            )
            
            if cancel_result['success']:
                # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ –ë–î
                auto_payment.status = 'cancelled'
                await self.db.commit()
                
                return {
                    'success': True,
                    'message': '–ê–≤—Ç–æ–ø–ª–∞—Ç–µ–∂ –æ—Ç–∫–ª—é—á–µ–Ω'
                }
        
        return {
            'success': False,
            'message': '–ê–≤—Ç–æ–ø–ª–∞—Ç–µ–∂ –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ —É–∂–µ –æ—Ç–∫–ª—é—á–µ–Ω'
        }
    
    async def get_user_auto_payment_info(
        self,
        user_id: int
    ) -> Dict[str, Any]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        
        auto_payment = await self._get_active_auto_payment(user_id)
        
        if auto_payment:
            return {
                'enabled': True,
                'amount': auto_payment.amount,
                'currency': auto_payment.currency,
                'next_payment_date': auto_payment.next_payment_date,
                'period_days': auto_payment.period_days,
                'status': auto_payment.status
            }
        
        return {'enabled': False}
```

### –≠—Ç–∞–ø 3: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –ø–ª–∞—Ç–µ–∂–Ω—ã–π workflow

#### 3.1 –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ webhook –æ–±—Ä–∞–±–æ—Ç–∫–∏
```python
# routes/webhooks.py - –æ–±—Ä–∞–±–æ—Ç–∫–∞ ResultURL

async def handle_robokassa_result(request_data: Dict):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç Robokassa"""
    
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∏
    
    payment_id = request_data.get('InvId')
    payment = await get_payment(payment_id)
    
    if payment.is_recurring_setup and payment.status == PaymentStatus.SUCCEEDED:
        # –≠—Ç–æ –ø–µ—Ä–≤—ã–π –ø–ª–∞—Ç–µ–∂ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ recurring
        auto_payment_service = AutoPaymentService()
        
        setup_result = await auto_payment_service.setup_auto_payment(
            user_id=payment.user_id,
            payment_id=payment.id,
            previous_invoice_id=payment_id
        )
        
        if setup_result['success']:
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            notification_service = AutoPayNotificationService()
            await notification_service.send_autopay_setup_success(
                payment.user_id,
                setup_result
            )
```

#### 3.2 –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞
```python
# services/payment_service.py

async def create_recurring_payment(
    self,
    user_id: int,
    subscription_type: str,
    enable_autopay: bool = False
) -> Dict[str, Any]:
    """–°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ —Å –æ–ø—Ü–∏–µ–π –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∞"""
    
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞
    
    if enable_autopay:
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ recurring –ø–ª–∞—Ç–µ–∂–∞
        payment.is_recurring_setup = True
        payment.is_recurring_enabled = True
        
        # –°–æ–∑–¥–∞–µ–º URL —Å recurring —Ñ–ª–∞–≥–æ–º
        robokassa_service = RobokassaService(provider_config)
        payment_url_data = robokassa_service.create_recurring_payment_url(
            amount=payment.amount,
            order_id=str(payment.id),
            description=f"–ü–æ–¥–ø–∏—Å–∫–∞ {subscription_type} —Å –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ–º",
            recurring=True
        )
    else:
        # –û–±—ã—á–Ω—ã–π —Ä–∞–∑–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂
        payment_url_data = robokassa_service.create_payment_url(...)
    
    return payment_url_data
```

### –≠—Ç–∞–ø 4: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –±–æ—Ç–∞ (–∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π UI)

#### 4.1 –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ handlers/payments.py
```python
# handlers/payments.py

@router.message(F.text.startswith("üí≥ –ü–æ–¥–ø–∏—Å–∫–∞"))
async def show_subscription_with_autopay_info(message: Message, state: FSMContext):
    """–ü–æ–∫–∞–∑–∞—Ç—å –ø–ª–∞–Ω—ã –ø–æ–¥–ø–∏—Å–æ–∫ —Å —É—á–µ—Ç–æ–º –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–µ–π"""
    
    telegram_id = message.from_user.id
    
    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–µ
    auto_payment_info = await get_user_auto_payment_info(telegram_id)
    
    if auto_payment_info['enabled']:
        # –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂
        subscription_info = await get_user_subscription_status(telegram_id)
        
        text = (
            f"üí≥ **–í–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞**\n\n"
            f"üìä **–¢–∞—Ä–∏—Ñ:** {subscription_info['plan_name']}\n"
            f"üìÖ **–î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ:** {subscription_info['end_date'].strftime('%d.%m.%Y')}\n\n"
            f"‚ö° **–ê–≤—Ç–æ–ø–ª–∞—Ç–µ–∂:** üü¢ –ê–∫—Ç–∏–≤–µ–Ω\n"
            f"üí∞ **–°—É–º–º–∞:** {auto_payment_info['amount']}‚ÇΩ\n"
            f"üìÖ **–°–ª–µ–¥—É—é—â–µ–µ —Å–ø–∏—Å–∞–Ω–∏–µ:** {auto_payment_info['next_payment_date'].strftime('%d.%m.%Y')}\n\n"
            f"üí° –ü–æ–¥–ø–∏—Å–∫–∞ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–¥–ª–µ–Ω–∞"
        )
        
        keyboard = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(
                text="‚ùå –û—Ç–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂",
                callback_data="autopay_disable"
            )],
            [InlineKeyboardButton(
                text="‚¨ÖÔ∏è –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
                callback_data="back_to_main_menu"
            )]
        ])
    
    else:
        # –ê–≤—Ç–æ–ø–ª–∞—Ç–µ–∂ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
        subscription_info = await get_user_subscription_status(telegram_id)
        days_remaining = subscription_info.get('days_remaining', 0)
        
        if days_remaining > 0:
            # –ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞, –Ω–æ –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
            text = (
                f"üí≥ **–í–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞**\n\n"
                f"üìä **–¢–∞—Ä–∏—Ñ:** {subscription_info['plan_name']}\n"
                f"üìÖ **–ò—Å—Ç–µ–∫–∞–µ—Ç:** {subscription_info['end_date'].strftime('%d.%m.%Y')} "
                f"(—á–µ—Ä–µ–∑ {days_remaining} –¥–Ω.)\n\n"
                f"üí° **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂** –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–æ–¥–ª–µ–Ω–∏—è\n"
                f"‚úÖ –£–¥–æ–±–Ω–æ - –Ω–µ –Ω—É–∂–Ω–æ –ø–æ–º–Ω–∏—Ç—å –æ –ø—Ä–æ–¥–ª–µ–Ω–∏–∏\n"
                f"‚úÖ –ù–∞–¥–µ–∂–Ω–æ - –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø—Ä–µ—Ä–≤–µ—Ç—Å—è"
            )
        else:
            # –ü–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–ª–∞
            text = (
                f"üí≥ **–ü–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–ª–∞**\n\n"
                f"üìä –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ –¥–ª—è –ø—Ä–æ–¥–ª–µ–Ω–∏—è:"
            )
        
        keyboard = await get_subscription_plans_keyboard_with_autopay()
    
    await message.answer(
        text,
        reply_markup=keyboard,
        parse_mode="Markdown"
    )

@router.callback_query(F.data == "autopay_disable")  
async def handle_autopay_disable(callback: CallbackQuery):
    """–û—Ç–∫–ª—é—á–µ–Ω–∏–µ –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∞"""
    
    telegram_id = callback.from_user.id
    
    # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è
    text = (
        "‚ö†Ô∏è **–û—Ç–∫–ª—é—á–µ–Ω–∏–µ –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∞**\n\n"
        "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏?\n\n"
        "–ü–æ—Å–ª–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –ø—Ä–æ–¥–ª–µ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –≤—Ä—É—á–Ω—É—é."
    )
    
    keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(
            text="‚úÖ –î–∞, –æ—Ç–∫–ª—é—á–∏—Ç—å",
            callback_data="autopay_disable_confirm"
        )],
        [InlineKeyboardButton(
            text="‚ùå –û—Ç–º–µ–Ω–∞",
            callback_data="back_to_subscription"
        )]
    ])
    
    await callback.message.edit_text(
        text,
        reply_markup=keyboard,
        parse_mode="Markdown"
    )

@router.callback_query(F.data == "autopay_disable_confirm")
async def handle_autopay_disable_confirm(callback: CallbackQuery):
    """–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∞"""
    
    telegram_id = callback.from_user.id
    
    # –û—Ç–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂ —á–µ—Ä–µ–∑ API
    result = await cancel_user_auto_payment(telegram_id)
    
    if result['success']:
        text = (
            "‚úÖ **–ê–≤—Ç–æ–ø–ª–∞—Ç–µ–∂ –æ—Ç–∫–ª—é—á–µ–Ω**\n\n"
            "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ –æ—Ç–∫–ª—é—á–µ–Ω–æ.\n"
            "–¢–µ–ø–µ—Ä—å –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –ø—Ä–æ–¥–ª–µ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –≤—Ä—É—á–Ω—É—é."
        )
        
        keyboard = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(
                text="üìã –ü–ª–∞–Ω—ã –ø–æ–¥–ø–∏—Å–æ–∫",
                callback_data="show_plans"
            )],
            [InlineKeyboardButton(
                text="‚¨ÖÔ∏è –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
                callback_data="back_to_main_menu"
            )]
        ])
    else:
        text = (
            "‚ùå **–û—à–∏–±–∫–∞**\n\n"
            "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É."
        )
        
        keyboard = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(
                text="üîÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞",
                callback_data="autopay_disable"
            )],
            [InlineKeyboardButton(
                text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥",
                callback_data="back_to_subscription"
            )]
        ])
    
    await callback.message.edit_text(
        text,
        reply_markup=keyboard,
        parse_mode="Markdown"
    )
```

#### 4.2 –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã —Å –æ–ø—Ü–∏–µ–π –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∞
```python
# keyboards/autopay_keyboards.py

async def get_subscription_plans_keyboard_with_autopay() -> InlineKeyboardMarkup:
    """–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –ø–ª–∞–Ω–æ–≤ —Å –æ–ø—Ü–∏–µ–π –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∞"""
    
    buttons = []
    subscription_plans = await plans_api_client.get_plans()
    
    for plan_id, plan in subscription_plans.items():
        # –ö–Ω–æ–ø–∫–∞ –æ–±—ã—á–Ω–æ–π –æ–ø–ª–∞—Ç—ã
        button_text = f"{plan['name']} - {plan['price']}‚ÇΩ"
        buttons.append([InlineKeyboardButton(
            text=button_text,
            callback_data=f"pay:{plan_id}"
        )])
        
        # –ö–Ω–æ–ø–∫–∞ —Å –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–æ–º
        autopay_text = f"‚ö° {plan['name']} + –ê–≤—Ç–æ–ø–ª–∞—Ç–µ–∂ - {plan['price']}‚ÇΩ"
        buttons.append([InlineKeyboardButton(
            text=autopay_text,
            callback_data=f"pay_autopay:{plan_id}"
        )])
    
    return InlineKeyboardMarkup(inline_keyboard=buttons)

@router.callback_query(F.data.startswith("pay_autopay:"))
async def handle_autopay_payment(callback: CallbackQuery):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–ø–ª–∞—Ç—ã —Å –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–æ–º"""
    
    plan_id = callback.data.split(":")[1]
    telegram_id = callback.from_user.id
    
    # –°–æ–∑–¥–∞–µ–º –ø–ª–∞—Ç–µ–∂ —Å —Ñ–ª–∞–≥–æ–º –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∞
    payment_data = {
        'telegram_id': telegram_id,
        'subscription_type': plan_id,
        'enable_autopay': True  # –ö–ª—é—á–µ–≤–æ–π —Ñ–ª–∞–≥
    }
    
    api_result = await create_payment_with_autopay(payment_data)
    
    if api_result['success']:
        text = (
            f"üí≥ **–û–ø–ª–∞—Ç–∞ —Å –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–æ–º**\n\n"
            f"üìã **–ü–ª–∞–Ω:** {api_result['plan_name']}\n"
            f"üí∞ **–°—É–º–º–∞:** {api_result['amount']}‚ÇΩ\n\n"
            f"‚ö° **–ê–≤—Ç–æ–ø–ª–∞—Ç–µ–∂ –±—É–¥–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω** –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π –æ–ø–ª–∞—Ç—ã\n"
            f"üîÑ –ü–æ–¥–ø–∏—Å–∫–∞ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–¥–ª–µ–≤–∞—Ç—å—Å—è –∫–∞–∂–¥—ã–π –ø–µ—Ä–∏–æ–¥\n\n"
            f"üëÜ –ù–∞–∂–º–∏—Ç–µ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –æ–ø–ª–∞—Ç–µ"
        )
        
        keyboard = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(
                text="üí≥ –ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ",
                url=api_result['payment_url']
            )],
            [InlineKeyboardButton(
                text="‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –ø–ª–∞–Ω–∞–º",
                callback_data="select_subscription"
            )]
        ])
        
        await callback.message.edit_text(
            text,
            reply_markup=keyboard,
            parse_mode="Markdown"
        )
```

### –≠—Ç–∞–ø 5: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∫–∏ –¥–ª—è –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–µ–π

#### 5.1 –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–µ–π –≤ –ø—Ä–æ—Ñ–∏–ª–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```python
# templates/admin/user_profile.html

<!-- –î–æ–±–∞–≤–∏—Ç—å –≤ —Å–µ–∫—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
<div class="card mt-3">
    <div class="card-header">
        <h5>‚ö° –ê–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∏</h5>
    </div>
    <div class="card-body">
        {% if user.auto_payment %}
            <div class="row">
                <div class="col-md-6">
                    <strong>–°—Ç–∞—Ç—É—Å:</strong> 
                    <span class="badge badge-success">üü¢ –ê–∫—Ç–∏–≤–µ–Ω</span>
                </div>
                <div class="col-md-6">
                    <strong>Recurring ID:</strong> 
                    <code>{{ user.auto_payment.robokassa_recurring_id }}</code>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-md-6">
                    <strong>–°—É–º–º–∞:</strong> {{ user.auto_payment.amount }}‚ÇΩ
                </div>
                <div class="col-md-6">
                    <strong>–ü–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å:</strong> {{ user.auto_payment.period_days }} –¥–Ω–µ–π
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-md-6">
                    <strong>–°–ª–µ–¥—É—é—â–µ–µ —Å–ø–∏—Å–∞–Ω–∏–µ:</strong> 
                    {{ user.auto_payment.next_payment_date.strftime('%d.%m.%Y') }}
                </div>
                <div class="col-md-6">
                    <strong>–ü–æ–ø—ã—Ç–æ–∫:</strong> {{ user.auto_payment.attempts_count }}
                </div>
            </div>
            <div class="mt-3">
                <button class="btn btn-danger btn-sm" onclick="cancelAutopay({{ user.id }})">
                    ‚ùå –û—Ç–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂
                </button>
            </div>
        {% else %}
            <p class="text-muted">–ê–≤—Ç–æ–ø–ª–∞—Ç–µ–∂ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω</p>
        {% endif %}
    </div>
</div>
```

#### 5.2 –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –ø–ª–∞—Ç–µ–∂–µ–π - –æ—Ç–º–µ—Ç–∫–∏ –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–µ–π
```python
# templates/admin/payments.html

<!-- –î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É –≤ —Ç–∞–±–ª–∏—Ü—É –ø–ª–∞—Ç–µ–∂–µ–π -->
<table class="table table-striped">
    <thead>
        <tr>
            <th>ID</th>
            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
            <th>–°—É–º–º–∞</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
            <th>–¢–∏–ø</th> <!-- –ù–æ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
            <th>–î–∞—Ç–∞</th>
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
    </thead>
    <tbody>
        {% for payment in payments %}
        <tr>
            <td>{{ payment.id }}</td>
            <td>{{ payment.user.telegram_username or payment.user.telegram_id }}</td>
            <td>{{ payment.amount }}‚ÇΩ</td>
            <td>
                <span class="badge badge-{{ 'success' if payment.status == 'succeeded' else 'warning' }}">
                    {{ payment.status }}
                </span>
            </td>
            <td>
                {% if payment.is_recurring_setup %}
                    <span class="badge badge-info">‚ö° –ü–µ—Ä–≤—ã–π recurring</span>
                {% elif payment.is_autopay_generated %}
                    <span class="badge badge-success">üîÑ –ê–≤—Ç–æ–ø–ª–∞—Ç–µ–∂</span>
                {% else %}
                    <span class="badge badge-secondary">üí≥ –û–±—ã—á–Ω—ã–π</span>
                {% endif %}
            </td>
            <td>{{ payment.created_at.strftime('%d.%m.%Y %H:%M') }}</td>
            <td>
                <a href="{{ url_for('admin.payment_detail', payment_id=payment.id) }}" 
                   class="btn btn-sm btn-outline-primary">–î–µ—Ç–∞–ª–∏</a>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
```

#### 5.3 –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ Payment –¥–ª—è –æ—Ç–º–µ—Ç–æ–∫
```python
# models/payment.py

# –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –ø–æ–ª—è –≤ –º–æ–¥–µ–ª—å Payment
is_autopay_generated = Column(Boolean, default=False)  # –§–ª–∞–≥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞
autopay_attempt_number = Column(Integer, nullable=True)  # –ù–æ–º–µ—Ä –ø–æ–ø—ã—Ç–∫–∏ –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∞
autopay_parent_payment_id = Column(Integer, ForeignKey('payments.id'), nullable=True)  # –°–≤—è–∑—å —Å –ø–µ—Ä–≤—ã–º –ø–ª–∞—Ç–µ–∂–æ–º
```

#### 5.4 –°—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–µ—Ç–∞–ª–µ–π –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∞
```python
# templates/admin/payment_detail.html

<!-- –î–æ–±–∞–≤–∏—Ç—å —Å–µ–∫—Ü–∏—é –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–µ–π –≤ –¥–µ—Ç–∞–ª–∏ –ø–ª–∞—Ç–µ–∂–∞ -->
{% if payment.is_recurring_setup or payment.is_autopay_generated %}
<div class="card mt-3">
    <div class="card-header">
        <h5>‚ö° –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–µ</h5>
    </div>
    <div class="card-body">
        {% if payment.is_recurring_setup %}
            <p><strong>–¢–∏–ø:</strong> –ü–µ—Ä–≤—ã–π –ø–ª–∞—Ç–µ–∂ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∞</p>
            <p><strong>Recurring ID:</strong> <code>{{ payment.robokassa_recurring_id }}</code></p>
            
            {% if payment.child_autopayments %}
            <h6 class="mt-3">–°–≤—è–∑–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∏:</h6>
            <ul class="list-group list-group-flush">
                {% for autopay in payment.child_autopayments %}
                <li class="list-group-item">
                    <a href="{{ url_for('admin.payment_detail', payment_id=autopay.id) }}">
                        –ü–ª–∞—Ç–µ–∂ #{{ autopay.id }}
                    </a>
                    - {{ autopay.amount }}‚ÇΩ 
                    - {{ autopay.created_at.strftime('%d.%m.%Y') }}
                    - {{ autopay.status }}
                </li>
                {% endfor %}
            </ul>
            {% endif %}
            
        {% elif payment.is_autopay_generated %}
            <p><strong>–¢–∏–ø:</strong> –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–Ω—ã–π –ø–ª–∞—Ç–µ–∂</p>
            <p><strong>–ü–æ–ø—ã—Ç–∫–∞ ‚Ññ:</strong> {{ payment.autopay_attempt_number }}</p>
            <p><strong>–†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –ø–ª–∞—Ç–µ–∂:</strong> 
                <a href="{{ url_for('admin.payment_detail', payment_id=payment.autopay_parent_payment_id) }}">
                    #{{ payment.autopay_parent_payment_id }}
                </a>
            </p>
        {% endif %}
    </div>
</div>
{% endif %}
```

#### 5.5 –î–µ–π—Å—Ç–≤–∏—è –∞–¥–º–∏–Ω–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∞–º–∏
```python
# routes/admin_payments.py

@router.post('/cancel-autopay/<int:user_id>')
@login_required
async def cancel_user_autopay(user_id: int):
    """–û—Ç–∫–ª—é—á–µ–Ω–∏–µ –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º"""
    
    auto_payment_service = AutoPaymentService()
    result = await auto_payment_service.cancel_auto_payment(user_id)
    
    if result['success']:
        flash('–ê–≤—Ç–æ–ø–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω', 'success')
    else:
        flash(f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏ –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∞: {result.get("message")}', 'error')
    
    return redirect(url_for('admin.user_profile', user_id=user_id))

@router.get('/autopay-stats')
@login_required  
async def autopay_statistics():
    """–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∞–º"""
    
    stats = await get_autopay_statistics()
    
    return render_template('admin/autopay_stats.html', stats=stats)
```

### –≠—Ç–∞–ø 6: –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–µ–π

#### 6.1 PaymentSchedulerService
```python
# services/payment_scheduler_service.py
class PaymentSchedulerService:
    
    async def process_due_autopayments(self):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ—Ä–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç—å"""
        
        # –ù–∞—Ö–æ–¥–∏–º –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ—Ä–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç—å
        due_autopayments = await self._get_due_autopayments()
        
        for autopay in due_autopayments:
            try:
                await self._process_single_autopayment(autopay)
            except Exception as e:
                logger.error(f"Error processing autopayment {autopay.id}: {e}")
    
    async def _process_single_autopayment(self, autopay: AutoPayment):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–¥–Ω–æ–≥–æ –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∞"""
        
        # –í—ã–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Robokassa Recurring API
        robokassa_service = RobokassaService(provider_config)
        
        recurring_result = await robokassa_service.create_recurring_subscription(
            previous_invoice_id=autopay.robokassa_recurring_id,
            amount=autopay.amount,
            period_days=autopay.period_days,
            description=f"–ê–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏"
        )
        
        if recurring_result['success']:
            # –ü–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–µ–Ω - –ø—Ä–æ–¥–ª–µ–≤–∞–µ–º –ø–æ–¥–ø–∏—Å–∫—É
            await self._handle_successful_autopayment(autopay)
        else:
            # –ü–ª–∞—Ç–µ–∂ –Ω–µ—É–¥–∞—á–µ–Ω - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
            await self._handle_failed_autopayment(autopay, recurring_result)
    
    async def _handle_successful_autopayment(self, autopay: AutoPayment):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∞"""
        
        # –ü—Ä–æ–¥–ª–µ–≤–∞–µ–º –ø–æ–¥–ø–∏—Å–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        subscription_service = SubscriptionService()
        await subscription_service.extend_user_subscription(
            autopay.user_id,
            autopay.period_days
        )
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–ª–∞—Ç–µ–∂–∞  
        autopay.next_payment_date = self._calculate_next_payment_date(autopay)
        autopay.attempts_count = 0
        await self.db.commit()
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º –ø—Ä–æ–¥–ª–µ–Ω–∏–∏
        notification_service = AutoPayNotificationService()
        await notification_service.send_autopay_renewal_success(
            autopay.user_id,
            {
                'amount': autopay.amount,
                'next_payment_date': autopay.next_payment_date
            }
        )
    
    async def _handle_failed_autopayment(self, autopay: AutoPayment, error_result):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ—É–¥–∞—á–Ω–æ–≥–æ –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∞"""
        
        autopay.attempts_count += 1
        
        # –ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
        error_type = self._classify_payment_error(error_result)
        
        # –°–æ–∑–¥–∞–µ–º retry attempt —Å–æ–≥–ª–∞—Å–Ω–æ creative guidelines
        retry_service = PaymentRetryService()
        await retry_service.schedule_retry_attempt(autopay.id, error_type)
        
        # –ï—Å–ª–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫
        if autopay.attempts_count >= self._get_max_attempts(error_type):
            await self._handle_max_attempts_reached(autopay)
```

#### 6.2 Cron Job –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
```python
# scripts/autopay_cron.py
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —á–µ—Ä–µ–∑ cron –∫–∞–∂–¥—ã–π —á–∞—Å
–î–æ–±–∞–≤–∏—Ç—å –≤ crontab: 0 * * * * /path/to/python /path/to/autopay_cron.py
"""

import asyncio
from services.payment_scheduler_service import PaymentSchedulerService

async def main():
    scheduler = PaymentSchedulerService()
    await scheduler.process_due_autopayments()
    print("Autopayment cron job completed")

if __name__ == "__main__":
    asyncio.run(main())
```

---

## üîÑ **–ü–æ–ª–Ω—ã–π workflow –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–µ–π:**

### **1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∞:**
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí –í—ã–±–∏—Ä–∞–µ—Ç "‚ö° –ü–ª–∞–Ω + –ê–≤—Ç–æ–ø–ª–∞—Ç–µ–∂" ‚Üí 
–°–æ–∑–¥–∞–µ—Ç—Å—è –ø–ª–∞—Ç–µ–∂ —Å —Ñ–ª–∞–≥–æ–º recurring=true ‚Üí 
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç —á–µ—Ä–µ–∑ Robokassa ‚Üí 
Robokassa –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç recurring_id ‚Üí 
–°–∏—Å—Ç–µ–º–∞ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –∞–≤—Ç–æ–ø–æ–¥–ø–∏—Å–∫—É
```

### **2. –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ —Å–ø–∏—Å–∞–Ω–∏—è:**
```
Cron –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π —á–∞—Å ‚Üí 
–ù–∞—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∏ –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è ‚Üí 
–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –≤ Robokassa Recurring API ‚Üí 
–ü—Ä–∏ —É—Å–ø–µ—Ö–µ –ø—Ä–æ–¥–ª–µ–≤–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É ‚Üí 
–ü—Ä–∏ –Ω–µ—É–¥–∞—á–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç retry –∞–ª–≥–æ—Ä–∏—Ç–º
```

### **3. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ –±–æ—Ç–µ:**
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Üí "üí≥ –ü–æ–¥–ø–∏—Å–∫–∞" ‚Üí 
–í–∏–¥–∏—Ç —Å—Ç–∞—Ç—É—Å –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∞ ‚Üí 
–ú–æ–∂–µ—Ç –æ—Ç–∫–ª—é—á–∏—Ç—å —á–µ—Ä–µ–∑ "‚ùå –û—Ç–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂" ‚Üí 
–°–∏—Å—Ç–µ–º–∞ –æ—Ç–º–µ–Ω—è–µ—Ç recurring –≤ Robokassa
```

---

**–¢–µ–ø–µ—Ä—å –ø–ª–∞–Ω –≤–∫–ª—é—á–∞–µ—Ç –ø–æ–ª–Ω—É—é —Ç–µ—Ö–Ω–∏—á–µ—Å–∫—É—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å Robokassa Recurring API!** 

–ì–æ—Ç–æ–≤ –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Å —á–µ—Ç–∫–∏–º –ø–æ–Ω–∏–º–∞–Ω–∏–µ–º:
- –ö–∞–∫ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –ø–µ—Ä–≤—ã–π recurring –ø–ª–∞—Ç–µ–∂
- –ö–∞–∫ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–ø–∏—Å–∞–Ω–∏—è  
- –ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —É–ø—Ä–∞–≤–ª—è—é—Ç –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∞–º–∏ –≤ –±–æ—Ç–µ
- –ö–∞–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –æ—à–∏–±–∫–∏ –∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏

---

## ‚úÖ –ò–¢–û–ì–ò –†–ï–ê–õ–ò–ó–ê–¶–ò–ò

### –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:

#### üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (–≠—Ç–∞–ø 1)
- –ú–∏–≥—Ä–∞—Ü–∏—è 009_add_auto_payments.sql
- –ú–æ–¥–µ–ª–∏: AutoPayment, PaymentRetryAttempt, UserNotificationPreferences
- –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏: Payment, Subscription

#### üí≥ Robokassa –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (–≠—Ç–∞–ø 2)
- –ú–µ—Ç–æ–¥—ã recurring API –≤ RobokassaService
- AutoPaymentService –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∞–º–∏
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è, –æ—Ç–º–µ–Ω—ã –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ recurring –ø–ª–∞—Ç–µ–∂–µ–π

#### üîÑ –ü–ª–∞—Ç–µ–∂–Ω—ã–π workflow (–≠—Ç–∞–ø 3)
- Webhook –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–µ–π
- –§–ª–∞–≥ enable_autopay –≤ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–µ–π
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π payment flow

#### ü§ñ –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –±–æ—Ç–∞ (–≠—Ç–∞–ø 4)
- –ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–µ–π
- –ö–Ω–æ–ø–∫–∏ –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è/–æ—Ç–∫–ª—é—á–µ–Ω–∏—è –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–µ–π
- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏: pay_autopay, autopay_disable, autopay_disable_confirm
- API endpoints –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∞–º–∏

#### üë®‚Äçüíº –ê–¥–º–∏–Ω–∫–∞ (–≠—Ç–∞–ø 5)
- –°–µ–∫—Ü–∏—è –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–µ–π –≤ –ø—Ä–æ—Ñ–∏–ª–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ö–æ–ª–æ–Ω–∫–∞ —Ç–∏–ø–∞ –ø–ª–∞—Ç–µ–∂–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ –ø–ª–∞—Ç–µ–∂–µ–π
- –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∞—Ö –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø–ª–∞—Ç–µ–∂–∞
- API endpoint –¥–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–µ–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º

#### ‚è∞ –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ (–≠—Ç–∞–ø 6)
- PaymentSchedulerService –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–µ–π
- Cron —Å–∫—Ä–∏–ø—Ç autopay_cron.py –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∫–∞–∂–¥—ã–π —á–∞—Å
- –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è retry –ª–æ–≥–∏–∫–∞ –ø–æ —Ç–∏–ø—É –æ—à–∏–±–∫–∏
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ —Å—Ç–∞—Ç—É—Å–µ –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–µ–π

### –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ cron:
```bash
# –î–æ–±–∞–≤–∏—Ç—å –≤ crontab –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∫–∞–∂–¥—ã–π —á–∞—Å:
0 * * * * /path/to/python /path/to/vpn-service/backend/scripts/autopay_cron.py >> /var/log/autopay.log 2>&1
```

### –ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é:
- –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ —Å –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–æ–º —á–µ—Ä–µ–∑ –±–æ—Ç–∞
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∞–º–∏ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ –±–æ—Ç–∞  
- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏—Ö –ø–ª–∞—Ç–µ–∂–µ–π

---

## üîÑ –£–õ–£–ß–®–ï–ù–ò–Ø –ò –î–û–ü–û–õ–ù–ï–ù–ò–Ø –°–ò–°–¢–ï–ú–´ –ê–í–¢–û–ü–õ–ê–¢–ï–ñ–ï–ô

### üì± UX –£–ª—É—á—à–µ–Ω–∏—è Telegram Bot

#### Inline-–∫–Ω–æ–ø–∫–∏ –≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è—Ö
```python
# –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å micro-copy –∏ inline –∫–Ω–æ–ø–∫–∞–º–∏

NOTIFICATION_TEMPLATES_ENHANCED = {
    'autopay_success': {
        'text': '–ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞. –¢—ã –Ω–∞ –≤–æ–ª–Ω–µ! üåä\n\nüí∞ –°–ø–∏—Å–∞–Ω–æ: {amount}‚ÇΩ\nüìÖ –°–ª–µ–¥—É—é—â–µ–µ —Å–ø–∏—Å–∞–Ω–∏–µ: {next_date}\n‚ö° –ê–≤—Ç–æ–ø–ª–∞—Ç–µ–∂ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —á–∞—Å—ã!',
        'inline_buttons': [
            [{'text': 'üí≥ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–æ–π', 'callback_data': 'subscription_manage'}],
            [{'text': 'üõ† –ü–æ–¥–¥–µ—Ä–∂–∫–∞', 'callback_data': 'support_contact'}]
        ]
    },
    
    'autopay_first_failure': {
        'text': '–û–ø, –∫–∞—Ä—Ç–∞ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∞ üòï –ü–æ–ø—Ä–æ–±—É–µ–º –µ—â—ë!\n\n‚ùå –ü—Ä–∏—á–∏–Ω–∞: {error_reason}\nüîÑ –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞: —á–µ—Ä–µ–∑ 24 —á–∞—Å–∞\nüí° –ü–æ–∫–∞ —á—Ç–æ –≤—Å—ë –ø–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º',
        'inline_buttons': [
            [{'text': 'üí≥ –ü–æ–ø–æ–ª–Ω–∏—Ç—å –∫–∞—Ä—Ç—É', 'url': 'https://bank-link.com'}],
            [{'text': 'üõ† –ü–æ–¥–¥–µ—Ä–∂–∫–∞', 'callback_data': 'support_contact'}]
        ]
    },
    
    'autopay_second_failure': {
        'text': '–•–º, –æ–ø—è—Ç—å —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫ ü§î\n\n‚ùå –ü—Ä–∏—á–∏–Ω–∞: {error_reason}\nüîÑ –ü–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞: —á–µ—Ä–µ–∑ 72 —á–∞—Å–∞\n‚è∞ –ü–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ {days_left} –¥–Ω–µ–π\n\n–°–∞–º–æ–µ –≤—Ä–µ–º—è —á—Ç–æ-—Ç–æ –ø—Ä–µ–¥–ø—Ä–∏–Ω—è—Ç—å!',
        'inline_buttons': [
            [{'text': 'üí≥ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã', 'callback_data': 'payment_method_update'}],
            [{'text': '‚ùå –û—Ç–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂', 'callback_data': 'autopay_disable'}],
            [{'text': 'üõ† –ü–æ–¥–¥–µ—Ä–∂–∫–∞', 'callback_data': 'support_contact'}]
        ]
    },
    
    'autopay_final_failure': {
        'text': '–ê–≤—Ç–æ–ø–ª–∞—Ç–µ–∂ –Ω–µ –ø—Ä–æ—à—ë–ª üòî –ù–æ –º—ã —Ç–µ–±—è –Ω–µ –±—Ä–æ—Å–∞–µ–º!\n\nüíî –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã\nüìÖ –ü–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–∞–µ—Ç –∑–∞–≤—Ç—Ä–∞\nüéØ –ü—Ä–æ–¥–ª–∏ –≤—Ä—É—á–Ω—É—é, —á—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å –¥–æ—Å—Ç—É–ø',
        'inline_buttons': [
            [{'text': 'üí≥ –ü—Ä–æ–¥–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É', 'callback_data': 'subscription_renew'}],
            [{'text': '‚ùå –û—Ç–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂', 'callback_data': 'autopay_disable'}],
            [{'text': 'üõ† –ü–æ–¥–¥–µ—Ä–∂–∫–∞', 'callback_data': 'support_contact'}]
        ]
    }
}
```

### üîÑ –£–ª—É—á—à–µ–Ω–Ω—ã–π Retry-–∞–ª–≥–æ—Ä–∏—Ç–º

#### –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ø—ã—Ç–æ–∫ –≤ –ë–î –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
```python
# models/payment_retry_attempt.py
class PaymentRetryAttempt(Base):
    __tablename__ = 'payment_retry_attempts'
    
    id = Column(Integer, primary_key=True)
    auto_payment_id = Column(Integer, ForeignKey('auto_payments.id'), nullable=False)
    attempt_number = Column(Integer, nullable=False)
    error_type = Column(String(50), nullable=False)  # 'insufficient_funds', 'technical_error', 'card_issue'
    error_message = Column(Text, nullable=True)
    robokassa_response = Column(Text, nullable=True)  # Raw –æ—Ç–≤–µ—Ç –¥–ª—è –¥–µ–±–∞–≥–∞
    scheduled_at = Column(DateTime, nullable=False)
    attempted_at = Column(DateTime, nullable=True)
    completed_at = Column(DateTime, nullable=True)
    result = Column(String(20), nullable=True)  # 'success', 'failed', 'pending'
    next_attempt_at = Column(DateTime, nullable=True)
    user_notified = Column(Boolean, default=False)
    notification_sent_at = Column(DateTime, nullable=True)
    created_at = Column(DateTime, default=func.now())
    
    # –°–≤—è–∑–∏
    auto_payment = relationship("AutoPayment", back_populates="retry_attempts")
```

#### –õ–æ–≥–∏–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ—Å–ª–µ –≤—Ç–æ—Ä–æ–π –Ω–µ—É–¥–∞—á–∏
```python
# services/auto_payment_service.py

async def handle_failed_autopayment_with_notifications(
    self, 
    autopay: AutoPayment, 
    error_result: Dict[str, Any]
):
    """–£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ—É–¥–∞—á–Ω–æ–≥–æ –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∞ —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏"""
    
    autopay.attempts_count += 1
    autopay.last_attempt_date = datetime.now()
    autopay.last_error_type = error_result.get('error_type')
    
    # –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –æ –ø–æ–ø—ã—Ç–∫–µ
    retry_attempt = PaymentRetryAttempt(
        auto_payment_id=autopay.id,
        attempt_number=autopay.attempts_count,
        error_type=error_result.get('error_type'),
        error_message=error_result.get('error'),
        robokassa_response=error_result.get('raw_response'),
        attempted_at=datetime.now(),
        result='failed'
    )
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–ª–µ–¥—É—é—â—É—é –ø–æ–ø—ã—Ç–∫—É
    next_attempt = self._calculate_next_attempt(
        error_result.get('error_type'), 
        autopay.attempts_count
    )
    
    if next_attempt:
        retry_attempt.next_attempt_at = next_attempt
        autopay.next_payment_date = next_attempt
        
        # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ –ø–æ–ø—ã—Ç–∫–∞–º
        if autopay.attempts_count == 1:
            # –ü–µ—Ä–≤–∞—è –Ω–µ—É–¥–∞—á–∞ - –±–∞–∑–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            await self._send_notification(
                autopay.user_id, 
                'autopay_first_failure', 
                error_result
            )
        elif autopay.attempts_count == 2:
            # –í—Ç–æ—Ä–∞—è –Ω–µ—É–¥–∞—á–∞ - —Å—Ä–æ—á–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å CTA
            await self._send_notification(
                autopay.user_id, 
                'autopay_second_failure', 
                error_result
            )
            retry_attempt.user_notified = True
            retry_attempt.notification_sent_at = datetime.now()
    else:
        # –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã
        autopay.status = 'failed'
        await self._send_notification(
            autopay.user_id, 
            'autopay_final_failure', 
            error_result
        )
        retry_attempt.user_notified = True
        retry_attempt.notification_sent_at = datetime.now()
    
    self.db.add(retry_attempt)
    await self.db.commit()
```

### üí≥ –£–ª—É—á—à–µ–Ω–∏—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Robokassa

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ recurring_id
```python
# services/robokassa_service.py

async def validate_recurring_id_before_charge(
    self,
    recurring_id: str
) -> Dict[str, Any]:
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ recurring_id –ø–µ—Ä–µ–¥ –ø–æ–ø—ã—Ç–∫–æ–π —Å–ø–∏—Å–∞–Ω–∏—è"""
    
    try:
        # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—É—Å recurring –ø–æ–¥–ø–∏—Å–∫–∏
        status_result = await self.get_recurring_status(recurring_id)
        
        if status_result.get('status') == 'active':
            return {
                'valid': True,
                'status': 'active',
                'message': 'Recurring ID –∞–∫—Ç–∏–≤–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Å–ø–∏—Å–∞–Ω–∏—é'
            }
        elif status_result.get('status') == 'cancelled':
            return {
                'valid': False,
                'status': 'cancelled',
                'message': 'Recurring ID –æ—Ç–º–µ–Ω–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º'
            }
        elif status_result.get('status') == 'expired':
            return {
                'valid': False,
                'status': 'expired',
                'message': 'Recurring ID –∏—Å—Ç–µ–∫'
            }
        else:
            return {
                'valid': False,
                'status': status_result.get('status', 'unknown'),
                'message': f'–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å: {status_result.get("status")}'
            }
            
    except Exception as e:
        logger.error(f"Error validating recurring_id {recurring_id}: {e}")
        return {
            'valid': False,
            'status': 'error',
            'message': f'–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏: {str(e)}'
        }
```

#### –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –ø–æ–¥–ø–∏—Å–∏ –¥–ª—è Recurring API
```python
def _generate_recurring_signature(
    self,
    params: Dict[str, Any],
    password: str
) -> str:
    """–°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –ø–æ–¥–ø–∏—Å—å –¥–ª—è Recurring API"""
    
    # –î–ª—è Recurring API Robokassa –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –æ—Å–æ–±—ã–π —Ñ–æ—Ä–º–∞—Ç –ø–æ–¥–ø–∏—Å–∏
    # MerchantLogin:OutSum:PreviousInvoiceID:Password
    
    if 'PreviousInvoiceID' in params:
        # –î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è recurring –ø–ª–∞—Ç–µ–∂–∞
        signature_string = (
            f"{params['MerchantLogin']}:"
            f"{params['OutSum']}:"
            f"{params['PreviousInvoiceID']}:"
            f"{password}"
        )
    elif 'ID' in params:
        # –î–ª—è –æ—Ç–º–µ–Ω—ã recurring
        signature_string = (
            f"{params['MerchantLogin']}:"
            f"{params['ID']}:"
            f"{password}"
        )
    else:
        # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ø–æ–¥–ø–∏—Å—å
        signature_string = f"{params['MerchantLogin']}:{password}"
    
    return hashlib.md5(signature_string.encode('utf-8')).hexdigest()

def _generate_cancel_recurring_signature(
    self,
    merchant_login: str,
    recurring_id: str,
    password: str
) -> str:
    """–ü–æ–¥–ø–∏—Å—å –¥–ª—è –æ—Ç–º–µ–Ω—ã recurring –ø–æ–¥–ø–∏—Å–∫–∏"""
    
    # MerchantLogin:ID:Password
    signature_string = f"{merchant_login}:{recurring_id}:{password}"
    return hashlib.md5(signature_string.encode('utf-8')).hexdigest()
```

#### –•—Ä–∞–Ω–µ–Ω–∏–µ recurring_id –∏ —Å–≤—è–∑–∏ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
```python
# models/user_subscription.py

class UserSubscription(Base):
    __tablename__ = 'user_subscriptions'
    
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è
    
    # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—è –¥–ª—è –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–µ–π
    auto_payment_enabled = Column(Boolean, default=False)
    robokassa_recurring_id = Column(String(255), nullable=True, unique=True)
    recurring_setup_payment_id = Column(Integer, ForeignKey('payments.id'), nullable=True)
    next_billing_date = Column(DateTime, nullable=True)  # –ö–ª—é—á–µ–≤–æ–µ –ø–æ–ª–µ –¥–ª—è cron
    auto_payment_amount = Column(Numeric(10, 2), nullable=True)
    auto_payment_status = Column(String(20), default='inactive')  # 'active', 'paused', 'cancelled'
    
    # –°–≤—è–∑–∏
    setup_payment = relationship("Payment", foreign_keys=[recurring_setup_payment_id])
    auto_payment = relationship("AutoPayment", back_populates="subscription", uselist=False)
```

### ‚è∞ –£–ª—É—á—à–µ–Ω–Ω—ã–π Cron –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ next_billing_date –∫–∞–∂–¥—ã–π —á–∞—Å
```python
# services/payment_scheduler_service.py

class PaymentSchedulerService:
    
    async def process_due_autopayments_enhanced(self):
        """–£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–µ–π —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø–æ next_billing_date"""
        
        current_time = datetime.now()
        
        # –ù–∞—Ö–æ–¥–∏–º –ø–æ–¥–ø–∏—Å–∫–∏ —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∞–º–∏, —É –∫–æ—Ç–æ—Ä—ã—Ö –ø–æ—Ä–∞ —Å–ø–∏—Å—ã–≤–∞—Ç—å
        due_subscriptions = await self.db.execute(
            select(UserSubscription)
            .join(AutoPayment)
            .where(
                and_(
                    UserSubscription.auto_payment_enabled == True,
                    AutoPayment.status == 'active',
                    UserSubscription.next_billing_date <= current_time,
                    AutoPayment.is_recurring_id_valid == True
                )
            )
        )
        
        for subscription in due_subscriptions.scalars():
            try:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å recurring_id –ø–µ—Ä–µ–¥ —Å–ø–∏—Å–∞–Ω–∏–µ–º
                validation_result = await self.robokassa_service.validate_recurring_id_before_charge(
                    subscription.robokassa_recurring_id
                )
                
                if not validation_result['valid']:
                    # –û—Ç–º–µ—á–∞–µ–º recurring_id –∫–∞–∫ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π
                    subscription.auto_payment.is_recurring_id_valid = False
                    await self._handle_invalid_recurring_id(subscription, validation_result)
                    continue
                
                # –í—ã–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–∞–Ω–∏–µ
                await self._process_single_autopayment_enhanced(subscription.auto_payment)
                
            except Exception as e:
                logger.error(f"Error processing autopayment for subscription {subscription.id}: {e}")
                
        await self.db.commit()
    
    async def _process_single_autopayment_enhanced(self, autopay: AutoPayment):
        """–£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ–¥–Ω–æ–≥–æ –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∞"""
        
        # –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –ø–æ–ø—ã—Ç–∫–∏
        attempt_number = autopay.attempts_count + 1
        
        # –í—ã–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Robokassa —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
        recurring_result = await self.robokassa_service.create_recurring_subscription_with_logging(
            auto_payment_id=autopay.id,
            previous_invoice_id=autopay.robokassa_recurring_id,
            amount=float(autopay.amount),
            description=f"–ê–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ (–ø–æ–ø—ã—Ç–∫–∞ {attempt_number})",
            attempt_number=attempt_number
        )
        
        if recurring_result['success']:
            await self._handle_successful_autopayment_enhanced(autopay)
        else:
            await self.handle_failed_autopayment_with_notifications(autopay, recurring_result)
```

#### Cron –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
```bash
# –î–æ–±–∞–≤–∏—Ç—å –≤ crontab –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∫–∞–∂–¥—ã–π —á–∞—Å
0 * * * * cd /path/to/project && python scripts/autopay_cron_enhanced.py >> /var/log/autopay.log 2>&1

# –î–ª—è –±–æ–ª–µ–µ —á–∞—Å—Ç–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ (–∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç)
0,30 * * * * cd /path/to/project && python scripts/autopay_cron_enhanced.py >> /var/log/autopay.log 2>&1
```

---

## ‚úÖ –ì–û–¢–û–í–ù–û–°–¢–¨ –ö –†–ï–ê–õ–ò–ó–ê–¶–ò–ò

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–µ–π –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Å —É—á–µ—Ç–æ–º –≤—Å–µ—Ö —É–ª—É—á—à–µ–Ω–∏–π –∏ –≥–æ—Ç–æ–≤–∞ –∫ implement —Ñ–∞–∑–µ:

### ÔøΩÔøΩ –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
‚úÖ **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**: –ú–æ–¥–µ–ª–∏ –¥–ª—è –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–µ–π, –ø–æ–¥–ø–∏—Å–æ–∫ –∏ retry-–ø–æ–ø—ã—Ç–æ–∫  
‚úÖ **Robokassa –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è**: Recurring API —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ –ø–æ–¥–ø–∏—Å—è–º–∏  
‚úÖ **–ë–æ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å**: –ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å micro-copy –∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º–∏ —Ç–µ–∫—Å—Ç–∞–º–∏  
‚úÖ **–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å**: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–∞–º–∏ —Å –º–∞—Ä–∫–µ—Ä–∞–º–∏ autopay  
‚úÖ **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**: –°–∏—Å—Ç–µ–º–∞ —Å inline-–∫–Ω–æ–ø–∫–∞–º–∏ –∏ CTA –ø–æ—Å–ª–µ 2-–π –Ω–µ—É–¥–∞—á–∏  
‚úÖ **Retry –ª–æ–≥–∏–∫–∞**: –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã —Å –ø–æ–ª–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º  
‚úÖ **Cron –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫**: –ü–æ—á–∞—Å–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ next_billing_date

### üîÑ –í–Ω–µ–¥—Ä–µ–Ω–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è
‚úÖ **UX**: Micro-copy + inline-–∫–Ω–æ–ø–∫–∏ –≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è—Ö  
‚úÖ **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞**: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫ –≤ –ë–î (PaymentRetryAttempt)  
‚úÖ **Robokassa**: –ü—Ä–æ–≤–µ—Ä–∫–∞ recurring_id –ø–µ—Ä–µ–¥ —Å–ø–∏—Å–∞–Ω–∏–µ–º  
‚úÖ **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**: –†–∞–∑–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ —Å —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º–∏ —Ç–µ–∫—Å—Ç–∞–º–∏  
‚úÖ **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ**: –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∏ –¥–ª—è Recurring API

### üöÄ –ì–æ—Ç–æ–≤–æ –∫ implement
–í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–µ—Ç–∞–ª—å–Ω–æ —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω—ã –∏ –≥–æ—Ç–æ–≤—ã –∫ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—é:
- –°—Ö–µ–º—ã –ë–î —Å –ø–æ–ª—è–º–∏ –¥–ª—è retry-–∞–Ω–∞–ª–∏—Ç–∏–∫–∏
- API –º–µ—Ç–æ–¥—ã —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫  
- UX —Å—Ü–µ–Ω–∞—Ä–∏–∏ —Å —Ç–µ–∫—Å—Ç–∞–º–∏ –∏ –∫–Ω–æ–ø–∫–∞–º–∏
- Cron —Å–∫—Ä–∏–ø—Ç—ã —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π recurring_id
- –ê–¥–º–∏–Ω –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å autopay –º–∞—Ä–∫–µ—Ä–∞–º–∏

## üîç QA –ü–†–û–í–ï–†–ö–ê –ò –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø - ‚úÖ –ó–ê–í–ï–†–®–ï–ù–ê

### ‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ 1: –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞ - –ò–°–ü–†–ê–í–õ–ï–ù–ê
**–ü—Ä–æ–±–ª–µ–º–∞**: –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∫–æ–ª–æ–Ω–∫–∏ `is_autopay_generated`, `autopay_attempt_number`, `autopay_parent_payment_id` –≤ —Ç–∞–±–ª–∏—Ü–µ `payments`
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**: 
- –î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –∫–æ–ª–æ–Ω–∫–∏ –≤ –ë–î
- –ü–ª–∞—Ç–µ–∂–∏ —Ç–µ–ø–µ—Ä—å —Å–æ–∑–¥–∞—é—Ç—Å—è —É—Å–ø–µ—à–Ω–æ —á–µ—Ä–µ–∑ API

### ‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ 2: –û—à–∏–±–∫–∞ "–ú–æ–π VPN –∫–ª—é—á" –≤ –±–æ—Ç–µ - –ò–°–ü–†–ê–í–õ–ï–ù–ê
**–ü—Ä–æ–±–ª–µ–º–∞**: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ VPN –∫–ª—é—á–µ–π (lowercase vs UPPERCASE)
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**:
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω —Ñ–∏–ª—å—Ç—Ä –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª—é—á–µ–π –≤ `vpn_manager_x3ui.py`
- –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ "ACTIVE" –≤–º–µ—Å—Ç–æ "active"
- VPN –∫–ª—é—á–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### ‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ 3: –ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∞–¥–º–∏–Ω–∫–µ - –ò–°–ü–†–ê–í–õ–ï–ù–ê
**–ü—Ä–æ–±–ª–µ–º–∞**: –û—à–∏–±–∫–∏ —Å enum –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–º–∏ –∫–æ–ª–æ–Ω–∫–∞–º–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ `auto_payments`
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**:
- –î–æ–±–∞–≤–ª–µ–Ω—ã –∫–æ–ª–æ–Ω–∫–∏ `last_error_type`, `is_recurring_id_valid` –≤ —Ç–∞–±–ª–∏—Ü—É `auto_payments`
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω —Ç–∏–ø –∫–æ–ª–æ–Ω–∫–∏ `status` –Ω–∞ enum `autopaymentstatus`
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –∑–Ω–∞—á–µ–Ω–∏—è enum –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö `payments`, `vpn_keys`
- –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ `admin_user_profile_page`

### ‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ 4: –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ü–ª–∞—Ç–µ–∂–∏ –≤ –∞–¥–º–∏–Ω–∫–µ - –ò–°–ü–†–ê–í–õ–ï–ù–ê
**–ü—Ä–æ–±–ª–µ–º–∞**: –û—à–∏–±–∫–∏ —Å enum –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**: 
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –∑–Ω–∞—á–µ–Ω–∏—è `recurring_status` –≤ —Ç–∞–±–ª–∏—Ü–µ `payments`
- –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–ª–∞—Ç–µ–∂–µ–π –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### ‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ 5: –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ü–ª–∞—Ç–µ–∂–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã –≤ –∞–¥–º–∏–Ω–∫–µ - –ò–°–ü–†–ê–í–õ–ï–ù–ê
**–ü—Ä–æ–±–ª–µ–º–∞**: –û—à–∏–±–∫–∏ —Å enum –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**: 
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã enum –∑–Ω–∞—á–µ–Ω–∏—è –≤–æ –≤—Å–µ—Ö —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö
- –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

## üß™ –í–´–ü–û–õ–ù–ï–ù–ù–´–ï –¢–ï–°–¢–´

### ‚úÖ –¢–µ—Å—Ç 1: –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
```bash
curl -s -X POST "http://localhost:8000/api/v1/payments/create" \
  -H "Content-Type: application/json" \
  -d '{"user_id": 1, "subscription_type": "monthly", "enable_autopay": false}'
```
**–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ –£—Å–ø–µ—à–Ω–æ - –ø–ª–∞—Ç–µ–∂ —Å–æ–∑–¥–∞–µ—Ç—Å—è —Å payment_id –∏ payment_url

### ‚úÖ –¢–µ—Å—Ç 2: –ü–æ–ª—É—á–µ–Ω–∏–µ VPN –∫–ª—é—á–∞ –≤ –±–æ—Ç–µ
**–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ –ê–∫—Ç–∏–≤–Ω—ã–µ VPN –∫–ª—é—á–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### ‚úÖ –¢–µ—Å—Ç 3: –ê–¥–º–∏–Ω–∫–∞ - –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
**URL**: `http://localhost:8000/admin/users/2/`
**–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ –ü—Ä–æ—Ñ–∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### ‚úÖ –¢–µ—Å—Ç 4: –ê–¥–º–∏–Ω–∫–∞ - —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–ª–∞—Ç–µ–∂–µ–π
**URL**: `http://localhost:8000/admin/payments`
**–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–ª–∞—Ç–µ–∂–µ–π —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –æ—à–∏–±–æ–∫

### ‚úÖ –¢–µ—Å—Ç 5: –ê–¥–º–∏–Ω–∫–∞ - –ø–ª–∞—Ç–µ–∂–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã
**URL**: `http://localhost:8000/admin/payment-providers`
**–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

## üìä –ò–¢–û–ì–ò QA

**–í—Å–µ–≥–æ –ø—Ä–æ–±–ª–µ–º**: 5
**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ**: 5 (100%)
**–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã**: ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–∞

### üîß –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ –ë–î:
1. `ALTER TABLE payments ADD COLUMN is_autopay_generated BOOLEAN DEFAULT FALSE`
2. `ALTER TABLE payments ADD COLUMN autopay_attempt_number INTEGER`
3. `ALTER TABLE payments ADD COLUMN autopay_parent_payment_id INTEGER REFERENCES payments(id)`
4. `UPDATE payments SET recurring_status = 'INACTIVE' WHERE recurring_status = 'inactive'`
5. `UPDATE vpn_keys SET status = 'ACTIVE' WHERE status = 'active'`
6. `UPDATE vpn_keys SET status = 'INACTIVE' WHERE status = 'inactive'`
7. `ALTER TABLE auto_payments ADD COLUMN last_error_type VARCHAR(50)`
8. `ALTER TABLE auto_payments ADD COLUMN is_recurring_id_valid BOOLEAN DEFAULT TRUE`
9. `ALTER TABLE auto_payments ALTER COLUMN status TYPE autopaymentstatus`

### üèÜ –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–ø–ª–∞—Ç–µ–∂–µ–π –≥–æ—Ç–æ–≤–∞ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É!
