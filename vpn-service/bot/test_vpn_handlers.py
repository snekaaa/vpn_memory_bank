"""
–¢–µ—Å—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö VPN handlers —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø–æ–¥–ø–∏—Å–∫–∏
–ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é VPNAccessControlService —Å bot handlers
"""

import asyncio
import sys
import os
from unittest.mock import Mock, AsyncMock, patch

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç–∏ –∫ –º–æ–¥—É–ª—è–º
sys.path.append(os.path.join(os.path.dirname(__file__), '..'))
sys.path.append(os.path.join(os.path.dirname(__file__), '../backend'))

print("üîç Starting VPN Handlers Test")

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∏–º–ø–æ—Ä—Ç–æ–≤
try:
    from handlers.vpn_simplified import check_vpn_access, show_subscription_required_message
    print("‚úÖ VPN handlers imported successfully")
except ImportError as e:
    print(f"‚ùå Failed to import VPN handlers: {e}")
    sys.exit(1)

# –°–æ–∑–¥–∞–µ–º –º–æ–∫ –æ–±—ä–µ–∫—Ç—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
class MockMessage:
    """–ú–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"""
    
    def __init__(self):
        self.text = ""
        self.parse_mode = None
        self.reply_markup = None
        
    async def edit_text(self, text, parse_mode=None, reply_markup=None, **kwargs):
        self.text = text
        self.parse_mode = parse_mode
        self.reply_markup = reply_markup
        print(f"üìù Message updated: {text[:100]}...")

class MockCallbackQuery:
    """–ú–æ–∫ callback query –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"""
    
    def __init__(self, telegram_id: int):
        self.from_user = Mock()
        self.from_user.id = telegram_id
        self.from_user.username = "testuser"
        self.from_user.first_name = "Test"
        self.message = MockMessage()
        
    async def answer(self, text=None):
        pass

class VPNHandlersTestSuite:
    """–¢–µ—Å—Ç–æ–≤—ã–π –Ω–∞–±–æ—Ä –¥–ª—è VPN handlers"""
    
    def __init__(self):
        self.test_results = []
        
    async def log_test(self, test_name: str, success: bool, message: str):
        """–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–æ–≤"""
        self.test_results.append({
            "test": test_name,
            "success": success,
            "message": message
        })
        
        status = "‚úÖ PASS" if success else "‚ùå FAIL"
        print(f"{status} {test_name}: {message}")
    
    async def test_check_vpn_access_with_mocked_db(self):
        """–¢–µ—Å—Ç —Ñ—É–Ω–∫—Ü–∏–∏ check_vpn_access —Å –º–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –ë–î"""
        try:
            # –ú–æ–∫–∞–µ–º access control
            with patch('handlers.vpn_simplified.VPN_ACCESS_CONTROL_AVAILABLE', True):
                with patch('handlers.vpn_simplified.get_db') as mock_get_db:
                    with patch('handlers.vpn_simplified.check_user_vpn_access') as mock_check:
                        
                        # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –º–æ–∫–∏
                        mock_session = AsyncMock()
                        mock_get_db.return_value.__aiter__ = AsyncMock(return_value=[mock_session])
                        mock_check.return_value = {
                            "has_access": False,
                            "reason": "no_subscription",
                            "message": "–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏"
                        }
                        
                        # –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é
                        result = await check_vpn_access(12345)
                        
                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                        success = (
                            result.get("has_access") == False and
                            result.get("reason") == "no_subscription"
                        )
                        
                        await self.log_test(
                            "VPN Access Check",
                            success,
                            f"Access check returned: {result}"
                        )
                        
                        return success
                        
        except Exception as e:
            await self.log_test(
                "VPN Access Check",
                False,
                f"Error testing VPN access check: {str(e)}"
            )
            return False
    
    async def test_show_subscription_required_message(self):
        """–¢–µ—Å—Ç —Ñ—É–Ω–∫—Ü–∏–∏ show_subscription_required_message"""
        try:
            # –°–æ–∑–¥–∞–µ–º –º–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏—è
            message = MockMessage()
            
            # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
            access_result = {
                "has_access": False,
                "reason": "no_subscription",
                "message": "–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏",
                "days_remaining": 0
            }
            
            # –ú–æ–∫–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
            with patch('handlers.vpn_simplified.get_subscription_keyboard_with_autopay') as mock_keyboard:
                mock_keyboard.return_value = Mock()
                
                # –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é
                await show_subscription_required_message(message, access_result)
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                success = (
                    "–ø–æ–¥–ø–∏—Å–∫" in message.text.lower() and
                    message.parse_mode == "Markdown"
                )
                
                await self.log_test(
                    "Subscription Required Message",
                    success,
                    f"Message displayed correctly with subscription prompt"
                )
                
                return success
                
        except Exception as e:
            await self.log_test(
                "Subscription Required Message",
                False,
                f"Error testing subscription message: {str(e)}"
            )
            return False
    
    async def test_full_handler_flow_no_access(self):
        """–¢–µ—Å—Ç –ø–æ–ª–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞ handler'–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±–µ–∑ –¥–æ—Å—Ç—É–ø–∞"""
        try:
            # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º handler
            from handlers.vpn_simplified import handle_create_or_remind_key
            
            # –°–æ–∑–¥–∞–µ–º –º–æ–∫ callback
            callback = MockCallbackQuery(telegram_id=99999)
            
            # –ú–æ–∫–∞–µ–º –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
            with patch('handlers.vpn_simplified.check_vpn_access') as mock_check:
                with patch('handlers.vpn_simplified.show_subscription_required_message') as mock_show:
                    
                    # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –º–æ–∫ - –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞
                    mock_check.return_value = {
                        "has_access": False,
                        "reason": "no_subscription"
                    }
                    mock_show.return_value = None
                    
                    # –¢–µ—Å—Ç–∏—Ä—É–µ–º handler
                    await handle_create_or_remind_key(callback)
                    
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–æ–∫–∞–∑–∞–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—Ä–æ–≤–µ—Ä–∫–µ –¥–æ—Å—Ç—É–ø–∞
                    access_check_shown = "–ø—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø" in callback.message.text.lower()
                    
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤—ã–∑–≤–∞–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏
                    subscription_shown = mock_show.called
                    
                    success = access_check_shown and subscription_shown
                    
                    await self.log_test(
                        "Full Handler Flow (No Access)",
                        success,
                        f"Handler correctly blocked access and showed subscription"
                    )
                    
                    return success
                    
        except Exception as e:
            await self.log_test(
                "Full Handler Flow (No Access)",
                False,
                f"Error testing full handler flow: {str(e)}"
            )
            return False
    
    async def test_full_handler_flow_with_access(self):
        """–¢–µ—Å—Ç –ø–æ–ª–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞ handler'–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –¥–æ—Å—Ç—É–ø–æ–º"""
        try:
            from handlers.vpn_simplified import handle_create_or_remind_key
            
            callback = MockCallbackQuery(telegram_id=12345)
            
            # –ú–æ–∫–∞–µ–º –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
            with patch('handlers.vpn_simplified.check_vpn_access') as mock_check:
                with patch('handlers.vpn_simplified.vpn_manager') as mock_vpn_manager:
                    
                    # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –º–æ–∫–∏ - –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø
                    mock_check.return_value = {
                        "has_access": True,
                        "reason": "active_subscription"
                    }
                    
                    mock_vpn_manager.get_or_create_user_key.return_value = {
                        "vless_url": "vless://test-key@server:443",
                        "id": 123
                    }
                    
                    # –¢–µ—Å—Ç–∏—Ä—É–µ–º handler
                    await handle_create_or_remind_key(callback)
                    
                    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫–ª—é—á –±—ã–ª –∑–∞–ø—Ä–æ—à–µ–Ω
                    vpn_key_requested = mock_vpn_manager.get_or_create_user_key.called
                    
                    success = vpn_key_requested
                    
                    await self.log_test(
                        "Full Handler Flow (With Access)",
                        success,
                        f"Handler correctly provided VPN key for authorized user"
                    )
                    
                    return success
                    
        except Exception as e:
            await self.log_test(
                "Full Handler Flow (With Access)",
                False,
                f"Error testing handler with access: {str(e)}"
            )
            return False
    
    async def run_all_tests(self):
        """–ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤"""
        print("\nüß™ Starting VPN Handlers Integration Tests...")
        print("=" * 60)
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã
        await self.test_check_vpn_access_with_mocked_db()
        await self.test_show_subscription_required_message()
        await self.test_full_handler_flow_no_access()
        await self.test_full_handler_flow_with_access()
        
        # –í—ã–≤–æ–¥–∏–º –æ—Ç—á–µ—Ç
        await self.print_test_report()
    
    async def print_test_report(self):
        """–í—ã–≤–æ–¥ –∏—Ç–æ–≥–æ–≤–æ–≥–æ –æ—Ç—á–µ—Ç–∞"""
        print("\n" + "=" * 60)
        print("üìä VPN HANDLERS TEST REPORT")
        print("=" * 60)
        
        total_tests = len(self.test_results)
        passed_tests = len([r for r in self.test_results if r["success"]])
        failed_tests = total_tests - passed_tests
        
        print(f"Total Tests: {total_tests}")
        print(f"‚úÖ Passed: {passed_tests}")
        print(f"‚ùå Failed: {failed_tests}")
        print(f"Success Rate: {(passed_tests/total_tests*100):.1f}%" if total_tests > 0 else "N/A")
        
        print("\nüìã DETAILED RESULTS:")
        for result in self.test_results:
            status = "‚úÖ" if result["success"] else "‚ùå"
            print(f"{status} {result['test']}: {result['message']}")
        
        print("\nüí° RECOMMENDATIONS:")
        if failed_tests == 0:
            print("‚úÖ All VPN handler tests passed!")
            print("üöÄ VPN handlers are correctly integrated with subscription checking")
            print("üöÄ Ready to proceed to Step 5: VPNKeyLifecycleService")
        else:
            print("‚ö†Ô∏è Some VPN handler tests failed. Issues to address:")
            for result in self.test_results:
                if not result["success"]:
                    print(f"   - {result['test']}: {result['message']}")
        
        print("\nüîß NEXT STEPS:")
        if failed_tests == 0:
            print("1. ‚úÖ VPN handlers updated with subscription checking")
            print("2. ‚úÖ Integration between bot and access control working")
            print("3. üöÄ Ready to implement VPNKeyLifecycleService (Step 5)")
            print("4. üöÄ Continue with automatic key deactivation/reactivation")
        else:
            print("1. üîß Fix failing VPN handler integration")
            print("2. üîß Verify imports and dependencies")
            print("3. ‚è∏Ô∏è Hold on lifecycle service until handlers are stable")

async def main():
    """–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"""
    tester = VPNHandlersTestSuite()
    await tester.run_all_tests()

if __name__ == "__main__":
    print("üöÄ VPN Handlers Integration Testing Suite")
    print("=" * 60)
    print("‚ÑπÔ∏è Testing VPN handlers with subscription access control")
    print("=" * 60)
    
    asyncio.run(main()) 