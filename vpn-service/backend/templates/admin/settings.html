{% extends "admin/base.html" %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_head %}
<style>
    .card {
        transition: box-shadow 0.15s ease-in-out;
    }
    .card:hover {
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    .form-control:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1050;
        min-width: 250px;
    }
    .success-toast {
        background-color: #d4edda;
        border-color: #c3e6cb;
        color: #155724;
    }
    .error-toast {
        background-color: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1>‚öôÔ∏è {{ page_title }}</h1>
                <div>
                    <button type="button" class="btn btn-outline-secondary" onclick="resetSettings()">
                        üîÑ –°–±—Ä–æ—Å–∏—Ç—å –∫ —É–º–æ–ª—á–∞–Ω–∏—é
                    </button>
                    <button type="submit" form="settingsForm" class="btn btn-success">
                        üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Success/Error Messages -->
    {% if success_message %}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="fas fa-check-circle"></i> {{ success_message }}
        <button type="button" class="close" data-dismiss="alert">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    {% endif %}
    
    {% if error_message %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-circle"></i> {{ error_message }}
        <button type="button" class="close" data-dismiss="alert">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    {% endif %}
    
    <!-- Settings Form -->
    <form id="settingsForm" method="post" action="/admin/settings">
        <div class="row">
            <!-- Site Settings Card -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-globe"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∞–π—Ç–∞</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="site_name">–ù–∞–∑–≤–∞–Ω–∏–µ —Å–∞–π—Ç–∞</label>
                            <input type="text" class="form-control" id="site_name" name="site_name" 
                                   value="{{ settings.site_name or '' }}" required>
                            <small class="form-text text-muted">–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ –∏ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö</small>
                        </div>
                        <div class="form-group">
                            <label for="site_domain">–î–æ–º–µ–Ω</label>
                            <input type="url" class="form-control" id="site_domain" name="site_domain" 
                                   value="{{ settings.site_domain or '' }}" placeholder="https://example.com">
                            <small class="form-text text-muted">–û—Å–Ω–æ–≤–Ω–æ–π –¥–æ–º–µ–Ω —Å–µ—Ä–≤–∏—Å–∞</small>
                        </div>
                        <div class="form-group">
                            <label for="site_description">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                            <textarea class="form-control" id="site_description" name="site_description" 
                                      rows="3">{{ settings.site_description or '' }}</textarea>
                            <small class="form-text text-muted">–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- User/Trial Settings Card -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-users"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="trial_enabled" 
                                       name="trial_enabled" {{ 'checked' if settings.trial_enabled }}>
                                <label class="form-check-label" for="trial_enabled">
                                    <strong>–í–∫–ª—é—á–∏—Ç—å —Ç—Ä–∏–∞–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥</strong>
                                </label>
                            </div>
                            <small class="form-text text-muted">–ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø–µ—Ä–∏–æ–¥</small>
                        </div>
                        <div class="form-group">
                            <label for="trial_days">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ç—Ä–∏–∞–ª–∞ (–¥–Ω–∏)</label>
                            <input type="number" class="form-control" id="trial_days" name="trial_days" 
                                   value="{{ settings.trial_days or 7 }}" min="0" max="365">
                            <small class="form-text text-muted">–û—Ç 0 –¥–æ 365 –¥–Ω–µ–π</small>
                        </div>
                        <div class="form-group">
                            <label for="trial_max_per_user">–ú–∞–∫—Å–∏–º—É–º —Ç—Ä–∏–∞–ª–æ–≤ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                            <input type="number" class="form-control" id="trial_max_per_user" 
                                   name="trial_max_per_user" value="{{ settings.trial_max_per_user or 1 }}" min="0" max="10">
                            <small class="form-text text-muted">–°–∫–æ–ª—å–∫–æ —Ä–∞–∑ –æ–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å —Ç—Ä–∏–∞–ª</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Bot Settings Card -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-robot"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="telegram_bot_token">–¢–æ–∫–µ–Ω –±–æ—Ç–∞</label>
                            <input type="text" class="form-control" id="telegram_bot_token" 
                                   name="telegram_bot_token" value="{{ settings.telegram_bot_token or '' }}">
                            <small class="form-text text-muted">–ü–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω —É @BotFather –≤ Telegram</small>
                        </div>
                        <div class="form-group">
                            <label for="bot_welcome_message">–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</label>
                            <textarea class="form-control" id="bot_welcome_message" name="bot_welcome_message" 
                                      rows="3" placeholder="–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ VPN —Å–µ—Ä–≤–∏—Å!">{{ settings.bot_welcome_message or '' }}</textarea>
                            <small class="form-text text-muted">–°–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏ –∫–æ–º–∞–Ω–¥–µ /start</small>
                        </div>
                        <div class="form-group">
                            <label for="bot_help_message">–°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–º–æ—â–∏</label>
                            <textarea class="form-control" id="bot_help_message" name="bot_help_message" 
                                      rows="3">{{ settings.bot_help_message or '' }}</textarea>
                            <small class="form-text text-muted">–°–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏ –∫–æ–º–∞–Ω–¥–µ /help</small>
                        </div>
                        <div class="form-group">
                            <label for="bot_apps_message">–°–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö</label>
                            <textarea class="form-control" id="bot_apps_message" name="bot_apps_message" 
                                      rows="2">{{ settings.bot_apps_message or '–°–∫–∞—á–∞–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –≤–∞—à–µ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:' }}</textarea>
                            <small class="form-text text-muted">–°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ —Å—Å—ã–ª–∫–∞–º–∏ –Ω–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Security Settings Card -->
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="fas fa-shield-alt"></i> –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="token_expire_minutes">–í—Ä–µ–º—è –∂–∏–∑–Ω–∏ —Ç–æ–∫–µ–Ω–∞ (–º–∏–Ω—É—Ç—ã)</label>
                            <input type="number" class="form-control" id="token_expire_minutes" 
                                   name="token_expire_minutes" value="{{ settings.token_expire_minutes or 30 }}" min="1" max="1440">
                            <small class="form-text text-muted">–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è: 30-60 –º–∏–Ω—É—Ç</small>
                        </div>
                        <div class="form-group">
                            <label for="admin_telegram_ids">Admin Telegram IDs</label>
                            <input type="text" class="form-control" id="admin_telegram_ids" 
                                   name="admin_telegram_ids" value="{{ ','.join(settings.admin_telegram_ids_list) if settings.admin_telegram_ids_list else '' }}">
                            <small class="form-text text-muted">–ß–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é: 123456,789012</small>
                        </div>
                        <div class="form-group">
                            <label for="admin_usernames">Admin usernames</label>
                            <input type="text" class="form-control" id="admin_usernames" 
                                   name="admin_usernames" value="{{ ','.join(settings.admin_usernames_list) if settings.admin_usernames_list else '' }}">
                            <small class="form-text text-muted">–ß–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é: user1,user2</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Action buttons at bottom -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="d-flex justify-content-end">
                    <button type="button" class="btn btn-outline-secondary mr-2" onclick="resetSettings()">
                        üîÑ –°–±—Ä–æ—Å–∏—Ç—å –∫ —É–º–æ–ª—á–∞–Ω–∏—é
                    </button>
                    <button type="submit" class="btn btn-success">
                        üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Reset Confirmation Modal -->
<div class="modal fade" id="resetModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–±—Ä–æ—Å–∞</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫ –∑–Ω–∞—á–µ–Ω–∏—è–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é?</p>
                <p class="text-warning"><strong>–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.</strong></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-danger" onclick="confirmReset()">–°–±—Ä–æ—Å–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div id="toastContainer" style="position: fixed; top: 20px; right: 20px; z-index: 1050;"></div>

<script>
// Real-time validation
document.getElementById('trial_days').addEventListener('input', function(e) {
    const value = parseInt(e.target.value);
    if (value < 0 || value > 365) {
        e.target.classList.add('is-invalid');
    } else {
        e.target.classList.remove('is-invalid');
    }
});

document.getElementById('trial_max_per_user').addEventListener('input', function(e) {
    const value = parseInt(e.target.value);
    if (value < 0 || value > 10) {
        e.target.classList.add('is-invalid');
    } else {
        e.target.classList.remove('is-invalid');
    }
});

document.getElementById('token_expire_minutes').addEventListener('input', function(e) {
    const value = parseInt(e.target.value);
    if (value < 1 || value > 1440) {
        e.target.classList.add('is-invalid');
    } else {
        e.target.classList.remove('is-invalid');
    }
});

// Reset settings function
function resetSettings() {
    $('#resetModal').modal('show');
}

function confirmReset() {
    $('#resetModal').modal('hide');
    
    // Create a form to submit reset request
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/admin/settings/reset';
    document.body.appendChild(form);
    form.submit();
}

// Auto-dismiss alerts after 5 seconds
setTimeout(function() {
    $('.alert').fadeOut();
}, 5000);

// Form submission with loading state
document.getElementById('settingsForm').addEventListener('submit', function(e) {
    const submitButton = this.querySelector('button[type="submit"]');
    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –°–æ—Ö—Ä–∞–Ω—è–µ–º...';
    submitButton.disabled = true;
});
</script>
{% endblock %} 