{% extends "../../base.html" %}

{% block title %}{{ node.name }} | VPN Admin{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="bi bi-hdd-network"></i> {{ node.name }}</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="/admin/nodes" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Назад к списку
            </a>
            <a href="/admin/nodes/{{ node.id }}/edit" class="btn btn-sm btn-primary">
                <i class="bi bi-pencil"></i> Редактировать
            </a>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteNode({{ node.id }}, '{{ node.name }}')">
                <i class="bi bi-trash"></i> Удалить
            </button>
        </div>
    </div>
</div>

<!-- Node Status Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card admin-card stats-card text-white">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h5 class="card-title">Статус</h5>
                        <p class="card-text display-6 mb-0">
                            {% if node.status == 'active' %}Активна
                            {% elif node.status == 'maintenance' %}Обслуживание
                            {% else %}Неактивна{% endif %}
                        </p>
                    </div>
                    <i class="bi bi-gear fa-2x"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card admin-card {% if node.health_status == 'healthy' %}stats-card success{% elif node.health_status == 'unknown' %}stats-card{% else %}stats-card danger{% endif %} text-white">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h5 class="card-title">Здоровье</h5>
                        <p class="card-text display-6 mb-0">
                            {% if node.health_status == 'healthy' %}Здоровая
                            {% elif node.health_status == 'unknown' %}Неизвестно
                            {% else %}Проблемы{% endif %}
                        </p>
                    </div>
                    <i class="bi bi-heart-pulse fa-2x"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card admin-card stats-card text-white">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h5 class="card-title">Пользователи</h5>
                        <p class="card-text display-6 mb-0">{{ node.current_users or 0 }}</p>
                        <small>Из {{ node.max_users }} мест</small>
                    </div>
                    <i class="bi bi-people fa-2x"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card admin-card {% if node.load_percentage < 70 %}stats-card success{% elif node.load_percentage < 90 %}stats-card warning{% else %}stats-card danger{% endif %} text-white">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h5 class="card-title">Загрузка</h5>
                        <p class="card-text display-6 mb-0">{{ node.load_percentage|round(1) }}%</p>
                    </div>
                    <i class="bi bi-speedometer2 fa-2x"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Node Details -->
<div class="row">
    <div class="col-md-6">
        <div class="card admin-card mb-4">
            <div class="card-header">
                <h5>Основная информация</h5>
            </div>
            <div class="card-body">
                <table class="table table-borderless">
                    <tbody>
                        <tr>
                            <th style="width: 30%">ID</th>
                            <td><code>#{{ node.id }}</code></td>
                        </tr>
                        <tr>
                            <th>Название</th>
                            <td><strong>{{ node.name }}</strong></td>
                        </tr>
                        <tr>
                            <th>Описание</th>
                            <td>{{ node.description or 'Не указано' }}</td>
                        </tr>
                        <tr>
                            <th>Локация</th>
                            <td>{{ node.location or 'Не указана' }}</td>
                        </tr>
                        <tr>
                            <th>Создана</th>
                            <td>{{ node.created_at.strftime('%d.%m.%Y %H:%M') }}</td>
                        </tr>
                        <tr>
                            <th>Обновлена</th>
                            <td>{{ node.updated_at.strftime('%d.%m.%Y %H:%M') }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card admin-card mb-4">
            <div class="card-header">
                <h5>Настройки X3UI</h5>
            </div>
            <div class="card-body">
                <table class="table table-borderless">
                    <tbody>
                        <tr>
                            <th style="width: 30%">URL</th>
                            <td><code>{{ node.x3ui_url }}</code></td>
                        </tr>
                        <tr>
                            <th>Имя пользователя</th>
                            <td><code>{{ node.x3ui_username }}</code></td>
                        </tr>
                        <tr>
                            <th>Пароль</th>
                            <td>
                                <div class="input-group">
                                    <input type="password" class="form-control form-control-sm" id="password" value="{{ node.x3ui_password }}" readonly>
                                    <button class="btn btn-outline-secondary btn-sm" type="button" id="showPassword">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <th>Соединение</th>
                            <td>
                                <button type="button" class="btn btn-sm btn-primary" id="testConnection">
                                    <i class="bi bi-wifi"></i> Проверить соединение
                                </button>
                                <span id="connectionStatus" class="ms-2"></span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Node Configuration -->
<div class="row">
    <div class="col-md-6">
        <div class="card admin-card mb-4">
            <div class="card-header">
                <h5>Конфигурация нагрузки</h5>
            </div>
            <div class="card-body">
                <table class="table table-borderless">
                    <tbody>
                        <tr>
                            <th style="width: 40%">Максимум пользователей</th>
                            <td><strong>{{ node.max_users }}</strong></td>
                        </tr>
                        <tr>
                            <th>Приоритет</th>
                            <td><strong>{{ node.priority }}</strong></td>
                        </tr>
                        <tr>
                            <th>Вес</th>
                            <td><strong>{{ node.weight }}</strong></td>
                        </tr>
                        <tr>
                            <th>Текущие пользователи</th>
                            <td><strong>{{ node.current_users or 0 }}</strong></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card admin-card mb-4">
            <div class="card-header">
                <h5>Статистика</h5>
            </div>
            <div class="card-body">
                <table class="table table-borderless">
                    <tbody>
                        <tr>
                            <th style="width: 40%">Время отклика</th>
                            <td>{{ node.response_time_ms or 'Н/Д' }} мс</td>
                        </tr>
                        <tr>
                            <th>Последняя проверка</th>
                            <td>
                                {% if node.last_health_check %}
                                    {{ node.last_health_check.strftime('%d.%m.%Y %H:%M') }}
                                {% else %}
                                    Никогда
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th>Загрузка</th>
                            <td>
                                <div class="progress">
                                    <div class="progress-bar {% if node.load_percentage < 70 %}bg-success{% elif node.load_percentage < 90 %}bg-warning{% else %}bg-danger{% endif %}" 
                                         style="width: {{ node.load_percentage }}%">
                                        {{ node.load_percentage|round(1) }}%
                                    </div>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <th>Действие</th>
                            <td>
                                <button type="button" class="btn btn-sm btn-outline-info" id="checkHealth">
                                    <i class="bi bi-heart-pulse"></i> Проверить здоровье
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- User Assignments -->
{% if node.user_assignments %}
<div class="card admin-card mb-4">
    <div class="card-header">
        <h5>Пользователи на ноде ({{ node.user_assignments|length }})</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Пользователь</th>
                        <th>Telegram</th>
                        <th>Назначен</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for assignment in node.user_assignments %}
                    {% if assignment.is_active %}
                    <tr>
                        <td><code>#{{ assignment.user.id }}</code></td>
                        <td>{{ assignment.user.username or assignment.user.email or 'Неизвестно' }}</td>
                        <td><code>{{ assignment.user.telegram_id }}</code></td>
                        <td>{{ assignment.assigned_at.strftime('%d.%m.%Y %H:%M') }}</td>
                        <td>
                            <button type="button" class="btn btn-sm btn-outline-primary" 
                                    onclick="showMigrateModal({{ assignment.user.id }}, '{{ assignment.user.username or assignment.user.email or 'Пользователь ' + assignment.user.id|string }}')">
                                <i class="bi bi-arrow-left-right"></i> Мигрировать
                            </button>
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% else %}
<div class="card admin-card mb-4">
    <div class="card-body text-center py-4">
        <i class="bi bi-people text-muted" style="font-size: 3rem;"></i>
        <h5 class="mt-3 text-muted">Нет пользователей на этой ноде</h5>
        <p class="text-muted">Пользователи будут автоматически назначены при регистрации VPN ключей</p>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    // Show/hide password
    document.getElementById('showPassword').addEventListener('click', function() {
        const passwordField = document.getElementById('password');
        const type = passwordField.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordField.setAttribute('type', type);
        this.innerHTML = type === 'password' ? '<i class="bi bi-eye"></i>' : '<i class="bi bi-eye-slash"></i>';
    });
    
    // Test connection
    document.getElementById('testConnection').addEventListener('click', function() {
        const statusElement = document.getElementById('connectionStatus');
        const button = this;
        
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Проверка...';
        statusElement.innerHTML = '';
        
        fetch('/admin/nodes/{{ node.id }}/test-connection', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                statusElement.innerHTML = '<span class="badge bg-success">Соединение установлено</span>';
                adminUtils.showToast('Соединение с нодой успешно установлено', 'success');
            } else {
                statusElement.innerHTML = '<span class="badge bg-danger">Ошибка соединения</span>';
                adminUtils.showToast('Не удалось подключиться к ноде', 'danger');
            }
        })
        .catch(error => {
            statusElement.innerHTML = '<span class="badge bg-danger">Ошибка запроса</span>';
            adminUtils.showToast(`Ошибка: ${error.message}`, 'danger');
        })
        .finally(() => {
            button.disabled = false;
            button.innerHTML = '<i class="bi bi-wifi"></i> Проверить соединение';
        });
    });
    
    // Check health
    document.getElementById('checkHealth').addEventListener('click', function() {
        const button = this;
        
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Проверка...';
        
        fetch('/admin/nodes/{{ node.id }}/check-health', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                adminUtils.showToast('Проверка здоровья завершена', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                adminUtils.showToast('Ошибка при проверке здоровья ноды', 'danger');
            }
        })
        .catch(error => {
            adminUtils.showToast(`Ошибка: ${error.message}`, 'danger');
        })
        .finally(() => {
            button.disabled = false;
            button.innerHTML = '<i class="bi bi-heart-pulse"></i> Проверить здоровье';
        });
    });
    
    // Delete node function
    async function deleteNode(nodeId, nodeName) {
        if (!confirm(`Вы уверены, что хотите удалить ноду "${nodeName}"?\n\nЭто действие нельзя отменить!`)) {
            return;
        }
        
        const spinner = adminUtils.showSpinner();
        
        try {
            const formData = new FormData();
            formData.append('migrate_users', 'true');
            
            const response = await fetch(`/admin/nodes/${nodeId}/delete`, {
                method: 'POST',
                body: formData
            });
            
            if (response.ok) {
                adminUtils.showToast(`Нода "${nodeName}" успешно удалена`, 'success');
                setTimeout(() => window.location.href = '/admin/nodes', 1000);
            } else {
                adminUtils.showToast('Ошибка при удалении ноды', 'danger');
            }
        } catch (error) {
            adminUtils.showToast(`Ошибка: ${error.message}`, 'danger');
        } finally {
            adminUtils.hideSpinner(spinner);
        }
    }
    
    // Show migrate modal function
    function showMigrateModal(userId, username) {
        adminUtils.showToast('Функция миграции пользователей будет реализована позже', 'info');
    }
</script>
{% endblock %} 