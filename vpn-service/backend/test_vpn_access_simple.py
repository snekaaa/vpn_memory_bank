"""
–ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç VPNAccessControlService –±–µ–∑ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î
–ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –ª–æ–≥–∏–∫—É —Ä–∞–±–æ—Ç—ã —Å–µ—Ä–≤–∏—Å–∞
"""

import asyncio
import sys
import os
from datetime import datetime, timezone, timedelta
from unittest.mock import Mock, AsyncMock

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
sys.path.append(os.path.join(os.path.dirname(__file__), '..'))

# –ú–æ–∫–∞–µ–º –∏–º–ø–æ—Ä—Ç—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–µ–∑ –ë–î
from unittest.mock import patch
from services.vpn_access_control_service import VPNAccessControlService

class MockUser:
    """–ú–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"""
    
    def __init__(self, user_id: int, telegram_id: int, has_active: bool, valid_until=None):
        self.id = user_id
        self.telegram_id = telegram_id
        self.subscription_status = Mock()
        self.subscription_status.value = "active" if has_active else "expired"
        self.valid_until = valid_until
        self.created_at = datetime.now(timezone.utc) - timedelta(days=30)
        self.autopay_enabled = False
        
    @property
    def has_active_subscription(self):
        """–ú–æ–∫–∞–µ–º –º–µ—Ç–æ–¥ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏"""
        if not self.valid_until:
            return False
        return self.valid_until > datetime.now(timezone.utc)
    
    @property
    def subscription_days_remaining(self):
        """–ú–æ–∫–∞–µ–º –º–µ—Ç–æ–¥ –ø–æ–¥—Å—á–µ—Ç–∞ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –¥–Ω–µ–π"""
        if not self.valid_until:
            return 0
        delta = self.valid_until - datetime.now(timezone.utc)
        return max(0, delta.days)

class VPNAccessControlSimpleTester:
    """–ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç–µ—Ä VPN Access Control Service"""
    
    def __init__(self):
        self.test_results = []
        
    async def log_test(self, test_name: str, success: bool, message: str, details: dict = None):
        """–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–æ–≤"""
        result = {
            "test": test_name,
            "success": success,
            "message": message,
            "timestamp": datetime.now().isoformat(),
            "details": details or {}
        }
        self.test_results.append(result)
        
        status = "‚úÖ PASS" if success else "‚ùå FAIL"
        print(f"{status} {test_name}: {message}")
        if details:
            for key, value in details.items():
                print(f"   {key}: {value}")
    
    async def test_user_with_active_subscription(self):
        """–¢–µ—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–æ–π"""
        try:
            # –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–æ–π
            user = MockUser(
                user_id=1,
                telegram_id=12345,
                has_active=True,
                valid_until=datetime.now(timezone.utc) + timedelta(days=15)
            )
            
            # –ú–æ–∫–∞–µ–º —Å–µ—Å—Å–∏—é –ë–î
            mock_session = AsyncMock()
            
            # –°–æ–∑–¥–∞–µ–º —Å–µ—Ä–≤–∏—Å
            service = VPNAccessControlService(mock_session)
            
            # –ú–æ–∫–∞–µ–º –º–µ—Ç–æ–¥ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            service._get_user_by_telegram_id = AsyncMock(return_value=user)
            
            # –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –¥–æ—Å—Ç—É–ø–∞
            result = await service.check_vpn_access(user.telegram_id)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            expected_access = True
            actual_access = result.get("has_access", False)
            success = actual_access == expected_access
            
            await self.log_test(
                "Active Subscription User",
                success,
                f"Access granted: {actual_access} (expected: {expected_access})",
                {
                    "has_access": actual_access,
                    "reason": result.get("reason"),
                    "days_remaining": result.get("days_remaining"),
                    "user_id": result.get("user_id")
                }
            )
            
            return result
            
        except Exception as e:
            await self.log_test(
                "Active Subscription User",
                False,
                f"Error testing active subscription user: {str(e)}"
            )
            return None
    
    async def test_user_with_expired_subscription(self):
        """–¢–µ—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∏—Å—Ç–µ–∫—à–µ–π –ø–æ–¥–ø–∏—Å–∫–æ–π"""
        try:
            # –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∏—Å—Ç–µ–∫—à–µ–π –ø–æ–¥–ø–∏—Å–∫–æ–π
            user = MockUser(
                user_id=2,
                telegram_id=67890,
                has_active=False,
                valid_until=datetime.now(timezone.utc) - timedelta(days=5)
            )
            
            # –ú–æ–∫–∞–µ–º —Å–µ—Å—Å–∏—é –ë–î
            mock_session = AsyncMock()
            
            # –°–æ–∑–¥–∞–µ–º —Å–µ—Ä–≤–∏—Å
            service = VPNAccessControlService(mock_session)
            
            # –ú–æ–∫–∞–µ–º –º–µ—Ç–æ–¥ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            service._get_user_by_telegram_id = AsyncMock(return_value=user)
            
            # –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –¥–æ—Å—Ç—É–ø–∞
            result = await service.check_vpn_access(user.telegram_id)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            expected_access = False
            actual_access = result.get("has_access", True)  # Default True –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            success = actual_access == expected_access
            
            await self.log_test(
                "Expired Subscription User",
                success,
                f"Access denied: {not actual_access} (expected: {not expected_access})",
                {
                    "has_access": actual_access,
                    "reason": result.get("reason"),
                    "days_remaining": result.get("days_remaining"),
                    "user_id": result.get("user_id")
                }
            )
            
            return result
            
        except Exception as e:
            await self.log_test(
                "Expired Subscription User",
                False,
                f"Error testing expired subscription user: {str(e)}"
            )
            return None
    
    async def test_nonexistent_user(self):
        """–¢–µ—Å—Ç –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        try:
            # –ú–æ–∫–∞–µ–º —Å–µ—Å—Å–∏—é –ë–î
            mock_session = AsyncMock()
            
            # –°–æ–∑–¥–∞–µ–º —Å–µ—Ä–≤–∏—Å
            service = VPNAccessControlService(mock_session)
            
            # –ú–æ–∫–∞–µ–º –º–µ—Ç–æ–¥ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç None)
            service._get_user_by_telegram_id = AsyncMock(return_value=None)
            
            # –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –¥–æ—Å—Ç—É–ø–∞
            result = await service.check_vpn_access(99999)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            expected_access = False
            actual_access = result.get("has_access", True)
            expected_reason = "user_not_found"
            actual_reason = result.get("reason")
            
            success = (actual_access == expected_access) and (actual_reason == expected_reason)
            
            await self.log_test(
                "Nonexistent User",
                success,
                f"Access denied for nonexistent user: {not actual_access}",
                {
                    "has_access": actual_access,
                    "reason": actual_reason,
                    "expected_reason": expected_reason
                }
            )
            
            return result
            
        except Exception as e:
            await self.log_test(
                "Nonexistent User",
                False,
                f"Error testing nonexistent user: {str(e)}"
            )
            return None
    
    async def test_subscription_plans_retrieval(self):
        """–¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è –ø–ª–∞–Ω–æ–≤ –ø–æ–¥–ø–∏—Å–∫–∏"""
        try:
            # –ú–æ–∫–∞–µ–º —Å–µ—Å—Å–∏—é –ë–î
            mock_session = AsyncMock()
            
            # –°–æ–∑–¥–∞–µ–º —Å–µ—Ä–≤–∏—Å
            service = VPNAccessControlService(mock_session)
            
            # –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–ª–∞–Ω–æ–≤
            result = await service.get_subscription_plans_for_user(12345)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            success = result.get("success", False)
            plans_count = len(result.get("plans", {}))
            
            await self.log_test(
                "Subscription Plans",
                success and plans_count > 0,
                f"Plans retrieved: {plans_count} plans available",
                {
                    "success": success,
                    "plans_count": plans_count,
                    "plans": list(result.get("plans", {}).keys())
                }
            )
            
            return result
            
        except Exception as e:
            await self.log_test(
                "Subscription Plans",
                False,
                f"Error retrieving subscription plans: {str(e)}"
            )
            return None
    
    async def run_all_tests(self):
        """–ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤"""
        print("üß™ Starting VPN Access Control Simple Tests...")
        print("=" * 50)
        print("‚ÑπÔ∏è  Testing VPN access control logic without database connection")
        print("=" * 50)
        
        # 1. –¢–µ—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–æ–π
        await self.test_user_with_active_subscription()
        
        # 2. –¢–µ—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∏—Å—Ç–µ–∫—à–µ–π –ø–æ–¥–ø–∏—Å–∫–æ–π  
        await self.test_user_with_expired_subscription()
        
        # 3. –¢–µ—Å—Ç –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        await self.test_nonexistent_user()
        
        # 4. –¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è –ø–ª–∞–Ω–æ–≤ –ø–æ–¥–ø–∏—Å–∫–∏
        await self.test_subscription_plans_retrieval()
        
        # –í—ã–≤–æ–¥–∏–º –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç
        await self.print_test_report()
    
    async def print_test_report(self):
        """–í—ã–≤–æ–¥ –∏—Ç–æ–≥–æ–≤–æ–≥–æ –æ—Ç—á–µ—Ç–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"""
        print("\n" + "=" * 50)
        print("üìä TEST REPORT")
        print("=" * 50)
        
        total_tests = len(self.test_results)
        passed_tests = len([r for r in self.test_results if r["success"]])
        failed_tests = total_tests - passed_tests
        
        print(f"Total Tests: {total_tests}")
        print(f"‚úÖ Passed: {passed_tests}")
        print(f"‚ùå Failed: {failed_tests}")
        print(f"Success Rate: {(passed_tests/total_tests*100):.1f}%" if total_tests > 0 else "N/A")
        
        print("\nüìã DETAILED RESULTS:")
        for result in self.test_results:
            status = "‚úÖ" if result["success"] else "‚ùå"
            print(f"{status} {result['test']}: {result['message']}")
        
        # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π —Ä–∞–±–æ—Ç—ã
        print("\nüí° RECOMMENDATIONS:")
        if failed_tests == 0:
            print("‚úÖ All logic tests passed! VPNAccessControlService core logic works correctly.")
            print("üöÄ Ready to proceed to VPN handlers integration (Step 4)")
        else:
            print("‚ö†Ô∏è  Some logic tests failed. Issues to address:")
            for result in self.test_results:
                if not result["success"]:
                    print(f"   - {result['test']}: {result['message']}")
        
        print("\nüîß NEXT STEPS:")
        if failed_tests == 0:
            print("1. ‚úÖ VPNAccessControlService core logic validated")
            print("2. üöÄ Ready to update VPN handlers with subscription check")
            print("3. üöÄ Ready to implement VPNKeyLifecycleService")
            print("4. üöÄ Continue with Step 4: Update VPN handlers")
        else:
            print("1. üîß Fix failing logic in VPNAccessControlService")
            print("2. üîß Review access control algorithms")
            print("3. ‚è∏Ô∏è  Hold on handler integration until logic is correct")
        
        print("\nüìù NOTE:")
        print("   This test used mocked data. For full validation, test with real database when available.")

async def main():
    """–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"""
    tester = VPNAccessControlSimpleTester()
    await tester.run_all_tests()

if __name__ == "__main__":
    print("üöÄ VPN Access Control Simple Testing Suite")
    print("=" * 50)
    print("‚ÑπÔ∏è  Testing core logic without database dependencies")
    print("‚ÑπÔ∏è  Using mocked user data for validation")
    print("=" * 50)
    
    asyncio.run(main()) 