{% extends "base.html" %}

{% block extra_css %}
<style>
    .config-section {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 1.5rem;
        margin-top: 1rem;
    }
    
    .config-field {
        margin-bottom: 1rem;
    }
    
    .config-field label {
        font-weight: 600;
        color: #495057;
    }
    
    .form-section {
        margin-bottom: 2rem;
        padding-bottom: 2rem;
        border-bottom: 1px solid #e9ecef;
    }
    
    .form-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }
    
    .form-section h5 {
        color: #495057;
        margin-bottom: 1rem;
        font-weight: 600;
    }
    
    .submit-section {
        background: #f8f9fa;
        padding: 1.5rem;
        margin: 2rem -1.5rem -1.5rem -1.5rem;
        border-top: 1px solid #e9ecef;
    }
    
    .sensitive-field {
        position: relative;
    }
    
    .sensitive-field .toggle-visibility {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #6c757d;
        cursor: pointer;
    }
    
    .provider-info {
        background: #e7f3ff;
        border: 1px solid #b3d9ff;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 2rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-1">
            <i class="bi bi-pencil"></i> Редактировать {{ provider.name }}
        </h2>
        <p class="text-muted mb-0">Изменение настроек платежного провайдера</p>
    </div>
    <div>
        <a href="/admin/payment-providers" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Назад к списку
        </a>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-body">
                <!-- Информация о провайдере -->
                <div class="provider-info">
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Тип:</strong> {{ provider.provider_type.title() }}<br>
                            <strong>Статус:</strong> 
                            <span class="badge bg-{{ 'success' if provider.is_active else 'secondary' }}">
                                {{ 'Активен' if provider.is_active else 'Неактивен' }}
                            </span>
                            {% if provider.is_test_mode %}
                            <span class="badge bg-warning">Тест</span>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <strong>Создан:</strong> {{ provider.created_at.strftime('%d.%m.%Y %H:%M') }}<br>
                            <strong>Обновлен:</strong> {{ provider.updated_at.strftime('%d.%m.%Y %H:%M') }}
                        </div>
                    </div>
                </div>
                
                <form id="editProviderForm" method="put" action="/admin/api/payment-providers/{{ provider.id }}">
                    
                    <!-- Основная информация -->
                    <div class="form-section">
                        <h5><i class="bi bi-info-circle"></i> Основная информация</h5>
                        
                        <div class="mb-3">
                            <label for="name" class="form-label">Название провайдера</label>
                            <input type="text" class="form-control" id="name" name="name" required
                                   value="{{ provider.name }}">
                        </div>
                        
                        <div class="mb-3">
                            <label for="description" class="form-label">Описание</label>
                            <textarea class="form-control" id="description" name="description" rows="3">{{ provider.description or '' }}</textarea>
                        </div>
                    </div>
                    
                    <!-- Конфигурация -->
                    <div class="form-section">
                        <h5><i class="bi bi-gear"></i> Конфигурация</h5>
                        
                        <div class="config-section">
                            <h6>Параметры подключения</h6>
                            {% set config_fields = {
                                'robokassa': [
                                    {'name': 'shop_id', 'label': 'Shop ID', 'type': 'text', 'required': True},
                                    {'name': 'password1', 'label': 'Пароль #1', 'type': 'password', 'required': True},
                                    {'name': 'password2', 'label': 'Пароль #2', 'type': 'password', 'required': True},
                                    {'name': 'base_url', 'label': 'Base URL', 'type': 'url', 'required': False}
                                ],
                                'yookassa': [
                                    {'name': 'shop_id', 'label': 'Shop ID', 'type': 'text', 'required': True},
                                    {'name': 'api_key', 'label': 'API Key', 'type': 'password', 'required': True}
                                ],
                                'freekassa': [
                                    {'name': 'merchant_id', 'label': 'ID магазина (Merchant ID)', 'type': 'text', 'required': True},
                                    {'name': 'api_key', 'label': 'API Key', 'type': 'text', 'required': True},
                                    {'name': 'secret1', 'label': 'Секретное слово №1', 'type': 'password', 'required': True},
                                    {'name': 'secret2', 'label': 'Секретное слово №2', 'type': 'password', 'required': True},
                                    {'name': 'confirmation_mode', 'label': 'Режим подтверждения', 'type': 'checkbox', 'required': False}
                                ]
                            } %}
                            
                            {% set fields = config_fields.get(provider.provider_type, []) %}
                            {% for field in fields %}
                            <div class="config-field">
                                {% if field.type == 'checkbox' %}
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="{{ field.name }}" 
                                           name="config_{{ field.name }}"
                                           {% if provider.config.get(field.name, False) %}checked{% endif %}>
                                    <label class="form-check-label" for="{{ field.name }}">
                                        {{ field.label }}
                                    </label>
                                </div>
                                {% else %}
                                <label for="{{ field.name }}" class="form-label">
                                    {{ field.label }}
                                    {% if field.required %}<span class="text-danger">*</span>{% endif %}
                                </label>
                                <div class="sensitive-field">
                                    <input type="{{ field.type }}" class="form-control" id="{{ field.name }}" 
                                           name="config_{{ field.name }}" 
                                           {% if field.required %}required{% endif %}
                                           value="{{ provider.config.get(field.name, '') }}">
                                    {% if field.type == 'password' %}
                                    <button type="button" class="toggle-visibility" onclick="togglePasswordVisibility('{{ field.name }}')">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                        
                        <!-- Универсальный блок URL-ов для всех провайдеров -->
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="bi bi-link-45deg"></i> URL-ы для настройки в платежной системе
                            </label>
                            <div class="webhook-urls-section p-3 bg-light border rounded">
                                {% if provider.provider_type == 'robokassa' %}
                                <div class="row">
                                    <div class="col-md-4">
                                        <small class="text-muted d-block mb-2">ResultURL (уведомления о платеже):</small>
                                        <div class="input-group">
                                            <input type="text" class="form-control font-monospace" readonly
                                                   value="{{ app_domain }}/api/v1/payments/robokassa/result"
                                                   onclick="this.select()">
                                            <button class="btn btn-outline-secondary" type="button" 
                                                    onclick="copyToClipboard('{{ app_domain }}/api/v1/payments/robokassa/result', this)">
                                                <i class="bi bi-clipboard"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <small class="text-muted d-block mb-2">SuccessURL (успешная оплата):</small>
                                        <div class="input-group">
                                            <input type="text" class="form-control font-monospace" readonly
                                                   value="{{ app_domain }}/api/v1/payments/robokassa/success"
                                                   onclick="this.select()">
                                            <button class="btn btn-outline-secondary" type="button" 
                                                    onclick="copyToClipboard('{{ app_domain }}/api/v1/payments/robokassa/success', this)">
                                                <i class="bi bi-clipboard"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <small class="text-muted d-block mb-2">FailURL (неуспешная оплата):</small>
                                        <div class="input-group">
                                            <input type="text" class="form-control font-monospace" readonly
                                                   value="{{ app_domain }}/api/v1/payments/robokassa/fail"
                                                   onclick="this.select()">
                                            <button class="btn btn-outline-secondary" type="button" 
                                                    onclick="copyToClipboard('{{ app_domain }}/api/v1/payments/robokassa/fail', this)">
                                                <i class="bi bi-clipboard"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <div class="alert alert-info mb-0" role="alert">
                                        <i class="bi bi-info-circle"></i>
                                        <strong>Инструкция:</strong> Скопируйте эти URL-ы и вставьте их в настройки вашего магазина в личном кабинете Робокассы.
                                        <br><small>ResultURL - обязательный для уведомлений о статусе платежа. SuccessURL и FailURL - опциональные для редиректа пользователя.</small>
                                    </div>
                                </div>
                                {% elif provider.provider_type == 'freekassa' %}
                                <div class="row">
                                    <div class="col-md-4">
                                        <small class="text-muted d-block mb-2">Result URL (webhook уведомления):</small>
                                        <div class="input-group">
                                            <input type="text" class="form-control font-monospace" readonly
                                                   value="{{ app_domain }}/api/v1/payments/freekassa/result"
                                                   onclick="this.select()">
                                            <button class="btn btn-outline-secondary" type="button" 
                                                    onclick="copyToClipboard('{{ app_domain }}/api/v1/payments/freekassa/result', this)">
                                                <i class="bi bi-clipboard"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <small class="text-muted d-block mb-2">Success URL (успешная оплата):</small>
                                        <div class="input-group">
                                            <input type="text" class="form-control font-monospace" readonly
                                                   value="{{ app_domain }}/api/v1/payments/freekassa/success"
                                                   onclick="this.select()">
                                            <button class="btn btn-outline-secondary" type="button" 
                                                    onclick="copyToClipboard('{{ app_domain }}/api/v1/payments/freekassa/success', this)">
                                                <i class="bi bi-clipboard"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <small class="text-muted d-block mb-2">Fail URL (неуспешная оплата):</small>
                                        <div class="input-group">
                                            <input type="text" class="form-control font-monospace" readonly
                                                   value="{{ app_domain }}/api/v1/payments/freekassa/fail"
                                                   onclick="this.select()">
                                            <button class="btn btn-outline-secondary" type="button" 
                                                    onclick="copyToClipboard('{{ app_domain }}/api/v1/payments/freekassa/fail', this)">
                                                <i class="bi bi-clipboard"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <div class="alert alert-info mb-0" role="alert">
                                        <i class="bi bi-info-circle"></i>
                                        <strong>Инструкция:</strong> Скопируйте эти URL-ы и вставьте их в настройки вашего проекта в личном кабинете FreeKassa.
                                        <br><small>Result URL - обязательный для webhook уведомлений. Success и Fail URL - опциональные для редиректа пользователя.</small>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                    </div>
                    
                    <!-- Настройки -->
                    <div class="form-section">
                        <h5><i class="bi bi-sliders"></i> Настройки</h5>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="priority" class="form-label">Приоритет</label>
                                    <input type="number" class="form-control" id="priority" name="priority" 
                                           value="{{ provider.priority }}" min="1" max="999">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Статус</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="is_active" name="is_active"
                                               {% if provider.is_active %}checked{% endif %}>
                                        <label class="form-check-label" for="is_active">
                                            Активен
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="is_test_mode" name="is_test_mode"
                                               {% if provider.is_test_mode %}checked{% endif %}>
                                        <label class="form-check-label" for="is_test_mode">
                                            Тестовый режим
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="is_default" name="is_default"
                                               {% if provider.is_default %}checked{% endif %}>
                                        <label class="form-check-label" for="is_default">
                                            По умолчанию для этого типа
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="submit-section">
                        <div class="d-flex justify-content-end">
                            <a href="/admin/payment-providers" class="btn btn-secondary me-2">Отмена</a>
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-check-circle"></i> Сохранить изменения
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <!-- Статистика -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-graph-up"></i> Статистика</h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <h4 class="text-primary">{{ provider.total_payments }}</h4>
                        <small class="text-muted">Всего платежей</small>
                    </div>
                    <div class="col-6">
                        <h4 class="text-success">{{ "%.1f"|format(provider.success_rate) }}%</h4>
                        <small class="text-muted">Успешность</small>
                    </div>
                </div>
                <hr>
                <div class="row text-center">
                    <div class="col-6">
                        <strong class="text-success">{{ provider.successful_payments }}</strong>
                        <br><small class="text-muted">Успешных</small>
                    </div>
                    <div class="col-6">
                        <strong class="text-danger">{{ provider.failed_payments }}</strong>
                        <br><small class="text-muted">Неудачных</small>
                    </div>
                </div>
                {% if provider.total_amount > 0 %}
                <hr>
                <div class="text-center">
                    <h5 class="text-info">{{ "%.2f"|format(provider.total_amount) }} ₽</h5>
                    <small class="text-muted">Общая сумма</small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Обработка формы
document.getElementById('editProviderForm').addEventListener('submit', handleSubmit);

function togglePasswordVisibility(fieldName) {
    const field = document.getElementById(fieldName);
    const button = field.nextElementSibling;
    const icon = button.querySelector('i');
    
    if (field.type === 'password') {
        field.type = 'text';
        icon.className = 'bi bi-eye-slash';
    } else {
        field.type = 'password';
        icon.className = 'bi bi-eye';
    }
}

// Функция копирования в буфер обмена
async function copyToClipboard(text, button) {
    try {
        await navigator.clipboard.writeText(text);
        const originalIcon = button.innerHTML;
        button.innerHTML = '<i class="bi bi-check"></i>';
        button.classList.remove('btn-outline-secondary');
        button.classList.add('btn-success');
        
        setTimeout(() => {
            button.innerHTML = originalIcon;
            button.classList.remove('btn-success');
            button.classList.add('btn-outline-secondary');
        }, 2000);
    } catch (err) {
        // Fallback для старых браузеров
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        
        const originalIcon = button.innerHTML;
        button.innerHTML = '<i class="bi bi-check"></i>';
        button.classList.remove('btn-outline-secondary');
        button.classList.add('btn-success');
        
        setTimeout(() => {
            button.innerHTML = originalIcon;
            button.classList.remove('btn-success');
            button.classList.add('btn-outline-secondary');
        }, 2000);
    }
}

async function handleSubmit(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    
    // Собираем данные
    const data = {
        name: formData.get('name'),
        description: formData.get('description') || null,
        priority: parseInt(formData.get('priority')) || 100,
        is_active: formData.has('is_active'),
        is_test_mode: formData.has('is_test_mode'),
        is_default: formData.has('is_default'),
        config: {}
    };
    
    // Собираем конфигурацию
    for (const [key, value] of formData.entries()) {
        if (key.startsWith('config_')) {
            data.config[key.replace('config_', '')] = value;
        }
    }
    
    try {
        const response = await fetch(`/admin/api/payment-providers/{{ provider.id }}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            window.location.href = '/admin/payment-providers';
        } else {
            const error = await response.json();
            alert('Ошибка при сохранении:\n\n' + (error.detail || 'Неизвестная ошибка'));
        }
    } catch (error) {
        console.error('Ошибка:', error);
        alert('Ошибка при сохранении провайдера');
    }
}
</script>
{% endblock %} 