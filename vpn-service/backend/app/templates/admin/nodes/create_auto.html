{% extends "base.html" %}

{% block title %}–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ VPN –ù–æ–¥—ã | VPN Admin{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="bi bi-robot"></i> –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ VPN –ù–æ–¥—ã</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="/admin/nodes" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É
            </a>
            <a href="/admin/nodes/create" class="btn btn-sm btn-outline-primary">
                <i class="bi bi-gear"></i> –†—É—á–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ
            </a>
        </div>
    </div>
</div>

<!-- Automated Deployment Form -->
<div class="card admin-card">
    <div class="card-header">
        <h5><i class="bi bi-robot me-2"></i>SSH –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è (Reality Mode)</h5>
        <small class="text-muted">–ü–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ VPN –Ω–æ–¥—ã —á–µ—Ä–µ–∑ SSH. –†–µ–∂–∏–º Reality - –±–µ–∑ –¥–æ–º–µ–Ω–æ–≤ –∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤.</small>
    </div>
    <div class="card-body">
        <form id="automatedNodeForm">
            <div class="row">
                <div class="col-md-8">
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="ssh_host" class="form-label">IP –∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞ *</label>
                                <input type="text" class="form-control" id="ssh_host" name="ssh_host" required 
                                       placeholder="91.84.101.70">
                                <div class="form-text">IP –∞–¥—Ä–µ—Å VPS —Å–µ—Ä–≤–µ—Ä–∞</div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="ssh_user" class="form-label">–õ–æ–≥–∏–Ω *</label>
                                <input type="text" class="form-control" id="ssh_user" name="ssh_user" value="root" required>
                                <div class="form-text">SSH –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="ssh_password" class="form-label">–ü–∞—Ä–æ–ª—å *</label>
                                <input type="password" class="form-control" id="ssh_password" name="ssh_password" required>
                                <div class="form-text">SSH –ø–∞—Ä–æ–ª—å</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Optional Settings (Collapsed) -->
                    <div class="mb-3">
                        <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#advancedSettings" aria-expanded="false">
                            <i class="bi bi-gear"></i> –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
                        </button>
                    </div>
                    
                    <div class="collapse" id="advancedSettings">
                        <div class="card card-body bg-light">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="auto_name" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–¥—ã</label>
                                        <input type="text" class="form-control" id="auto_name" name="name" placeholder="–ê–≤—Ç–æ-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è">
                                        <div class="form-text">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="auto_location" class="form-label">–°—Ç—Ä–∞–Ω–∞</label>
                                        <select class="form-select" id="auto_location" name="location" required>
                                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É</option>
                                            {% if countries %}
                                                {% for country in countries %}
                                                    <option value="{{ country.name }}">
                                                        {{ country.flag_emoji }} {{ country.name }}
                                                    </option>
                                                {% endfor %}
                                            {% else %}
                                                <option value="–ù–∏–¥–µ—Ä–ª–∞–Ω–¥—ã">üá≥üá± –ù–∏–¥–µ—Ä–ª–∞–Ω–¥—ã</option>
                                                <option value="–ì–µ—Ä–º–∞–Ω–∏—è">üá©üá™ –ì–µ—Ä–º–∞–Ω–∏—è</option>
                                            {% endif %}
                                        </select>
                                        <div class="form-text">–°—Ç—Ä–∞–Ω–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è VPN –Ω–æ–¥—ã</div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="auto_custom_port" class="form-label">–ü–æ—Ä—Ç VPN</label>
                                        <input type="number" class="form-control" id="auto_custom_port" name="custom_port" value="443" min="1" max="65535">
                                        <div class="form-text">–ü–æ—Ä—Ç –¥–ª—è VPN —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="sni_mask" class="form-label">SNI –º–∞—Å–∫–∏—Ä–æ–≤–∫–∞</label>
                                        <input type="text" class="form-control" id="sni_mask" name="sni_mask" value="apple.com">
                                        <div class="form-text">–î–æ–º–µ–Ω –¥–ª—è –º–∞—Å–∫–∏—Ä–æ–≤–∫–∏ —Ç—Ä–∞—Ñ–∏–∫–∞</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="auto_add_to_balancer" name="auto_add_to_balancer" checked>
                                    <label class="form-check-label" for="auto_add_to_balancer">
                                        –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–∏—Ç—å –≤ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="card bg-info bg-opacity-10 border-info">
                        <div class="card-body">
                            <h6 class="card-title"><i class="bi bi-info-circle"></i> Reality Mode</h6>
                            <ul class="list-unstyled small">
                                <li>‚úÖ –ë–µ–∑ –¥–æ–º–µ–Ω–æ–≤ –∏ SSL</li>
                                <li>‚úÖ –ü—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø–æ IP</li>
                                <li>‚úÖ –ú–∞—Å–∫–∏—Ä–æ–≤–∫–∞ —Ç—Ä–∞—Ñ–∏–∫–∞</li>
                                <li>‚úÖ –ë—ã—Å—Ç—Ä–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ ~5-10 –º–∏–Ω</li>
                                <li>‚úÖ –£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞–º</li>
                            </ul>
                            
                            <div class="mt-3">
                                <small class="text-muted">
                                    <strong>–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:</strong><br>
                                    1. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø–æ SSH<br>
                                    2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Xray<br>
                                    3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–µ–π Reality<br>
                                    4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ X3UI –ø–∞–Ω–µ–ª–∏<br>
                                    5. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="d-flex justify-content-between align-items-center mt-4">
                <div>
                    <button type="button" class="btn btn-success btn-lg" id="startDeployment">
                        <i class="bi bi-play-circle"></i> –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
                    </button>
                    <button type="button" class="btn btn-outline-primary" id="validateConfig">
                        <i class="bi bi-check-circle"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
                    </button>
                </div>
                <div class="text-muted">
                    <small><i class="bi bi-clock"></i> –û–∂–∏–¥–∞–µ–º–æ–µ –≤—Ä–µ–º—è: 5-10 –º–∏–Ω—É—Ç</small>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Progress Modal -->
<div class="modal fade" id="deploymentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-gear-fill"></i> –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ VPN –Ω–æ–¥—ã
                </h5>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span>–ü—Ä–æ–≥—Ä–µ—Å—Å —É—Å—Ç–∞–Ω–æ–≤–∫–∏</span>
                        <span id="progressPercentage">0%</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" id="progressBar" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <strong>–¢–µ–∫—É—â–∏–π —ç—Ç–∞–ø:</strong>
                    <span id="currentStep">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...</span>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <small>–õ–æ–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</small>
                    </div>
                    <div class="card-body p-2" style="max-height: 300px; overflow-y: auto;">
                        <pre id="deploymentLogs" class="mb-0 small"></pre>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="closeModal" data-bs-dismiss="modal" disabled>
                    –ó–∞–∫—Ä—ã—Ç—å
                </button>
                <button type="button" class="btn btn-success" id="viewNode" style="display: none;">
                    <i class="bi bi-eye"></i> –ü–µ—Ä–µ–π—Ç–∏ –∫ –Ω–æ–¥–µ
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let deploymentId = null;
let progressInterval = null;

document.getElementById('startDeployment').addEventListener('click', function() {
    const form = document.getElementById('automatedNodeForm');
    const formData = new FormData(form);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
    const requiredFields = ['ssh_host', 'ssh_user', 'ssh_password'];
    for (let field of requiredFields) {
        if (!formData.get(field)) {
            alert(`–ü–æ–ª–µ "${field}" –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è`);
            return;
        }
    }
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
    startDeployment(formData);
});

document.getElementById('validateConfig').addEventListener('click', function() {
    const form = document.getElementById('automatedNodeForm');
    const formData = new FormData(form);
    
    fetch('/admin/nodes/api/validate-deployment-config', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ! –°–µ—Ä–≤–µ—Ä –≥–æ—Ç–æ–≤ –∫ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é.');
        } else {
            alert('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + data.error);
        }
    })
    .catch(error => {
        alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏: ' + error.message);
    });
});

function startDeployment(formData) {
    fetch('/admin/nodes/api/auto-deploy', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            deploymentId = data.deployment_id;
            showProgressModal();
            startProgressTracking();
        } else {
            alert('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è: ' + data.error);
        }
    })
    .catch(error => {
        alert('–û—à–∏–±–∫–∞: ' + error.message);
    });
}

function showProgressModal() {
    const modal = new bootstrap.Modal(document.getElementById('deploymentModal'));
    modal.show();
}

function startProgressTracking() {
    progressInterval = setInterval(updateProgress, 2000);
}

function updateProgress() {
    if (!deploymentId) return;
    
    fetch(`/admin/nodes/api/deployment-progress/${deploymentId}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const progress = data.progress;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
            document.getElementById('progressBar').style.width = progress.percentage + '%';
            document.getElementById('progressPercentage').textContent = progress.percentage + '%';
            document.getElementById('currentStep').textContent = progress.current_step;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–≥–∏
            if (progress.logs) {
                document.getElementById('deploymentLogs').textContent = progress.logs.join('\n');
                const logsContainer = document.getElementById('deploymentLogs').parentElement;
                logsContainer.scrollTop = logsContainer.scrollHeight;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
            if (progress.status === 'COMPLETED') {
                clearInterval(progressInterval);
                document.getElementById('closeModal').disabled = false;
                document.getElementById('viewNode').style.display = 'inline-block';
                document.getElementById('viewNode').onclick = () => {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ node_id —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–µ null, –∏–Ω–∞—á–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–ø–∏—Å–æ–∫ –Ω–æ–¥
                    if (progress.node_id && progress.node_id !== null) {
                        window.location.href = `/admin/nodes/${progress.node_id}`;
                    } else {
                        // –ï—Å–ª–∏ node_id –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –Ω–æ–¥
                        window.location.href = '/admin/nodes';
                    }
                };
                
                // –£—Å–ø–µ—à–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
                document.getElementById('progressBar').classList.remove('progress-bar-animated');
                document.getElementById('progressBar').classList.add('bg-success');
                
            } else if (progress.status === 'FAILED') {
                clearInterval(progressInterval);
                document.getElementById('closeModal').disabled = false;
                
                // –û—à–∏–±–∫–∞
                document.getElementById('progressBar').classList.remove('progress-bar-animated');
                document.getElementById('progressBar').classList.add('bg-danger');
                document.getElementById('currentStep').innerHTML = '<span class="text-danger">‚ùå –û—à–∏–±–∫–∞ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è</span>';
            }
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:', error);
    });
}

// –û—á–∏—Å—Ç–∫–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª–∞
document.getElementById('deploymentModal').addEventListener('hidden.bs.modal', function() {
    if (progressInterval) {
        clearInterval(progressInterval);
        progressInterval = null;
    }
});
</script>

<style>
.deployment-method-card {
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid transparent;
}

.deployment-method-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.deployment-method-card.selected {
    border-color: #0d6efd;
    background-color: rgba(13, 110, 253, 0.1);
}

.admin-card {
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border: none;
}
</style>
{% endblock %} 